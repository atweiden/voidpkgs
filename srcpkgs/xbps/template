maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="xbps"
version=0.53
revision=5
short_desc="The XBPS package system utilities"
depends+=" ca-certificates"
depends+=" xbps-triggers"
makedepends+=" libarchive-devel"
makedepends+=" libressl-devel"
makedepends+=" zlib-devel"
hostmakedepends="pkg-config"
homepage="https://github.com/void-linux/xbps"
license="BSD-2-Clause"
distfiles="https://github.com/void-linux/xbps/archive/$version.tar.gz"
checksum="360b3149141fec46dd6da9019605bcee48ee4d29bffe5aa47a9fd5fa68ccd5f4"
build_style="configure"
bootstrap="yes"

if [[ -n "$CHROOT_READY" ]]; then
  makedepends+=" atf-devel"
  xbps-tests_package() {
    short_desc+=" - Kyua testsuite"
    pkg_install() {
      vmove usr/tests
    }
  }
fi

do_configure() {
  HAVE_VASPRINTF=1 ./configure \
    "${CHROOT_READY:+--enable-tests}" \
    --bindir="/usr/bin" \
    --enable-debug \
    --prefix="/usr" \
    --sysconfdir="/etc"
}

post_install() {
  case "$XBPS_TARGET_MACHINE" in
    aarch64*)
      # XXX different repo location
      echo "repository=https://repo.voidlinux.eu/current/aarch64" > \
        "$DESTDIR/usr/share/xbps.d/00-repository-main.conf"
      ;;
    *-musl)
      # XXX different repo location
      echo "repository=https://repo.voidlinux.eu/current/musl" > \
        "$DESTDIR/usr/share/xbps.d/00-repository-main.conf"
      ;;
    *)
      echo "repository=https://repo.voidlinux.eu/current" > \
        "$DESTDIR/usr/share/xbps.d/00-repository-main.conf"
      ;;
  esac
  vmkdir etc/xbps.d
  touch "$DESTDIR/etc/xbps.d/.empty"
  vlicense COPYING
  vlicense COPYING.3RDPARTY
}

libxbps_package() {
  short_desc+=" - runtime library"
  pkg_install() {
    vmove "usr/lib/*.so.*"
  }
}

libxbps-devel_package() {
  short_desc+=" - runtime library (development files)"
  depends+=" libarchive-devel"
  depends+=" libxbps>=$version"
  depends+=" zlib-devel"
  pkg_install() {
    vmove usr/include
    vmove "usr/lib/*.a"
    vmove "usr/lib/*.so"
    vmove usr/lib/pkgconfig
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0:

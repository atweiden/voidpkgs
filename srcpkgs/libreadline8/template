maintainer="nox"
pkgname="libreadline8"
_dist_ver=8.0
_patch_ver=004
version="$_dist_ver.$_patch_ver"
revision=1
short_desc="GNU Readline Library"
makedepends="ncurses-devel"
homepage="https://tiswww.cwru.edu/php/chet/readline/rltop.html"
license="GPL-3.0-or-later"
distfiles+=" $GNU_SITE/readline/readline-$_dist_ver.tar.gz"
distfiles+=" $GNU_SITE/readline/readline-$_dist_ver-patches/readline${_dist_ver/./}-001"
distfiles+=" $GNU_SITE/readline/readline-$_dist_ver-patches/readline${_dist_ver/./}-002"
distfiles+=" $GNU_SITE/readline/readline-$_dist_ver-patches/readline${_dist_ver/./}-003"
distfiles+=" $GNU_SITE/readline/readline-$_dist_ver-patches/readline${_dist_ver/./}-004"
checksum+=" e339f51971478d369f8a053a330a190781acb9864cf4c541060f12078948e461"
checksum+=" d8e5e98933cf5756f862243c0601cb69d3667bb33f2c7b751fe4e40b2c3fd069"
checksum+=" 36b0febff1e560091ae7476026921f31b6d1dd4c918dcb7b741aa2dad1aec8f7"
checksum+=" 94ddb2210b71eb5389c7756865d60e343666dfb722c85892f8226b26bb3eeaef"
checksum+=" b1aa3d2a40eee2dea9708229740742e649c32bb8db13535ea78f8ac15377394c"
skip_extraction+=" readline${_dist_ver/./}-001"
skip_extraction+=" readline${_dist_ver/./}-002"
skip_extraction+=" readline${_dist_ver/./}-003"
skip_extraction+=" readline${_dist_ver/./}-004"
wrksrc="readline-$_dist_ver"
build_style="gnu-configure"
configure_args+=" --enable-multibyte"
configure_args+=" --with-curses"
bootstrap="yes"

post_patch() {
  cd "$wrksrc"
  for p in $(seq -w 001 "$_patch_ver"); do
    patch -s -Np0 \
          -i "$XBPS_SRCDISTDIR/$pkgname-$version/readline${_dist_ver/./}-$p"
    msg_normal " Applying patch readline${_dist_ver/./}-$p.\n"
  done
  vsed \
    -i \
    -e 's|-Wl,-rpath,$(libdir) ||g' \
    support/shobj-conf
}

do_build() {
  make \
    "$makejobs" \
    LDFLAGS="-lncurses" \
    SHLIB_LIBS="-lncurses"
}

do_install() {
  make \
    DESTDIR="$DESTDIR" \
    LDFLAGS="-lncurses" \
    SHLIB_LIBS="-lncurses" \
    install

  # examples and README, COPYING, INSTALL
  rm -rf $DESTDIR/usr/share/{readline,doc}
}

libhistory8_package() {
  short_desc+=" - history library"
  pkg_install() {
    vmove "usr/lib/libhistory.so.*"
  }
}

readline-devel_package() {
  depends+=" $sourcepkg-${version}_$revision"
  depends+=" libhistory8-${version}_$revision"
  depends+=" ncurses-devel"
  short_desc+=" - development files"
  pkg_install() {
    vmove usr/lib/pkgconfig
    vmove usr/include
    vmove usr/share/man/man3
    vmove usr/share/info
    vmove "usr/lib/*.a"
    vmove "usr/lib/*.so"
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

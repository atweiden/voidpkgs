maintainer="nox"
pkgname="rust-bootstrap"
version=1.74.1
revision=1
short_desc="Rust programming language bootstrap toolchain"
if [[ "$XBPS_TARGET_LIBC" == "musl" ]]; then
  depends="libexecinfo-devel"
fi
homepage="https://www.rust-lang.org/"
_bootstrap_url="https://static.rust-lang.org/dist"
case "$XBPS_TARGET_MACHINE" in
  x86_64*|i686) ;;
  # see srcpkgs/rust-bootstrap/files/generating-distfiles.md for details
  *) _bootstrap_url="https://repo-default.voidlinux.org/distfiles" ;;
esac
# hardcode platform triplets, this info isn't available here without
# hacky workarounds
case "$XBPS_TARGET_MACHINE" in
  i686)
    distfiles+=" $_bootstrap_url/rustc-$version-i686-unknown-linux-gnu.tar.xz"
    distfiles+=" $_bootstrap_url/rust-std-$version-i686-unknown-linux-gnu.tar.xz"
    checksum+=" d93054003c3b6ba8752466b27cf6f61140b3e04f1aa69315b77041ab1152af4d"
    checksum+=" de7bfa755339d81d0f375c04a6b5432fba8452fdc72154fbe5cd5e1147902b90"
    ;;
  x86_64)
    distfiles+=" $_bootstrap_url/rustc-$version-x86_64-unknown-linux-gnu.tar.xz"
    distfiles+=" $_bootstrap_url/rust-std-$version-x86_64-unknown-linux-gnu.tar.xz"
    checksum+=" b30e2d1b6b139874caa3fc81fbc3098e88cf01b98e891ce591d12ad4f0299437"
    checksum+=" df435e3254c03ccbfc9e733ae33b399f5f99bd488974bc07d8b1db91a12ee95b"
    ;;
  x86_64-musl)
    distfiles+=" $_bootstrap_url/rustc-$version-x86_64-unknown-linux-musl.tar.xz"
    distfiles+=" $_bootstrap_url/rust-std-$version-x86_64-unknown-linux-musl.tar.xz"
    checksum+=" 8c743d9ed5490b544f7728c248804846ee6ffbdf3840b5844e7e9deb9cd71f0d"
    checksum+=" 98f190039c7e7922838f9716443b7ddfec2aa3dc229f5b1813a26591c557997e"
    ;;
  # placeholders for user-supplied distfiles
  ppc64le)
    distfiles+=" $_bootstrap_url/rustc-$version-powerpc64le-unknown-linux-gnu.tar.xz"
    distfiles+=" $_bootstrap_url/rust-std-$version-powerpc64le-unknown-linux-gnu.tar.xz"
    checksum+=" badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadb"
    checksum+=" badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadb"
    ;;
  ppc64le-musl)
    distfiles+=" $_bootstrap_url/rustc-$version-powerpc64le-unknown-linux-musl.tar.xz"
    distfiles+=" $_bootstrap_url/rust-std-$version-powerpc64le-unknown-linux-musl.tar.xz"
    checksum+=" badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadb"
    checksum+=" badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadb"
    ;;
  ppc64)
    distfiles+=" $_bootstrap_url/rustc-$version-powerpc64-unknown-linux-gnu.tar.xz"
    distfiles+=" $_bootstrap_url/rust-std-$version-powerpc64-unknown-linux-gnu.tar.xz"
    checksum+=" badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadb"
    checksum+=" badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadb"
    ;;
  ppc)
    distfiles+=" $_bootstrap_url/rustc-$version-powerpc-unknown-linux-gnu.tar.xz"
    distfiles+=" $_bootstrap_url/rust-std-$version-powerpc-unknown-linux-gnu.tar.xz"
    checksum+=" badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadb"
    checksum+=" badbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadbadb"
    ;;
  *)
    broken="rust bootstrap binaries unavailable for $XBPS_TARGET_MACHINE"
    ;;
esac
nostrip="yes"
repository="bootstrap"
conflicts="rust>=0"
lib32disabled="yes"

do_install() {
  for d in *; do
    cd "$d"
    ./install.sh \
        --prefix="/usr" \
        --destdir="$DESTDIR"
    cd ..
  done

  vlicense "rustc-$version-$RUST_TARGET/COPYRIGHT"
  vlicense "rustc-$version-$RUST_TARGET/LICENSE-APACHE"
  vlicense "rustc-$version-$RUST_TARGET/LICENSE-MIT"

  rm -rf "$DESTDIR/usr/share/doc/rust"
  rm -f "$DESTDIR/usr/lib/rustlib/$RUST_TARGET/bin"/rust-ll*
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

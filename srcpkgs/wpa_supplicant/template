maintainer="nox"
pkgname="wpa_supplicant"
version=2.9
revision=1
short_desc="WPA/WPA2/IEEE 802.1X Supplicant"
makedepends+=" libnl3-devel"
makedepends+=" libressl-devel"
makedepends+=" $(vopt_if dbus dbus-devel)"
makedepends+=" $(vopt_if readline readline-devel)"
hostmakedepends="pkg-config"
homepage="http://w1.fi/wpa_supplicant/"
license="BSD-3-Clause"
distfiles="http://w1.fi/releases/$pkgname-$version.tar.gz"
checksum="fcbdee7b4a64bea8177973299c8c824419c413ec2e3a95db63dd6a5dc3541f17"
conf_files="/etc/wpa_supplicant/wpa_supplicant.conf"
build_wrksrc="$pkgname"
build_options+=" dbus"
build_options+=" readline"
build_options_default+=" dbus"
build_options_default+=" readline"
reverts="2.7_1"

pre_build() {
  vsed \
    -e 's|/usr/local|$(PREFIX)|g' \
    -i Makefile
  cp -f "$FILESDIR/config" .config

  if [[ -n "$build_option_dbus" ]]; then
    sed \
      -i \
      -e 's, -u, -uq,' \
      dbus/*.service.in
  else
    sed \
      -i \
      -e 's|#\{0,1\}\(CONFIG_CTRL_IFACE_DBUS\)=\(.*\)|\1=|' \
      -e 's|#\{0,1\}\(CONFIG_CTRL_IFACE_DBUS_NEW\)=\(.*\)|\1=|' \
      -e 's|#\{0,1\}\(CONFIG_CTRL_IFACE_DBUS_INTRO\)=\(.*\)|\1=|' .config
  fi

  if [[ -n "$build_option_readline" ]]; then
    sed \
      -i \
      -e 's|#\{0,1\}\(CONFIG_READLINE\)=\(.*\)|\1=y|' \
      .config
  fi
}
do_build() {
  export CFLAGS+=" $(pkg-config --cflags libnl-3.0) $CPPFLAGS"
  make \
    "$makejobs" \
    BINDIR="/usr/bin" \
    PREFIX="/usr" \
    V=1
}

do_install() {
  make \
    BINDIR="/usr/bin" \
    DESTDIR="$DESTDIR" \
    PREFIX="/usr" \
    install

  if [[ -n "$build_option_dbus" ]]; then
    install -d "$DESTDIR/usr/share/dbus-1/system-services"
    install -m 644 dbus/*.service "$DESTDIR/usr/share/dbus-1/system-services/"
    vinstall "dbus/dbus-$pkgname.conf" 644 etc/dbus-1/system.d "$pkgname.conf"
  fi

  vinstall "$FILESDIR/$pkgname.conf" 640 "etc/$pkgname"
  vsconf wpa_supplicant.conf

  for d in doc/docbook/*.[58]; do
    vman "$d"
  done

  rm "$DESTDIR/usr/share/man/man8/wpa_gui.8"
  rm "$DESTDIR/usr/share/man/man8/wpa_priv.8"
  rm "$DESTDIR/usr/share/man/man8/eapol_test.8"
}

post_install() {
  vlicense README
  vsv wpa_supplicant
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

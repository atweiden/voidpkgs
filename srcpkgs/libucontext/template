maintainer="nox"
pkgname="libucontext"
version=0.13.1
revision=1
short_desc="Compatibility layer providing ucontext functions"
archs="*-musl"
hostmakedepends="scdoc"
homepage="https://github.com/kaniini/libucontext"
license="ISC"
distfiles="https://github.com/kaniini/libucontext/archive/$pkgname-$version.tar.gz"
checksum="5d3517d12f1a605713cfb94c1ceda89e399bf534a4a85c9ff356cc329e12e4c1"
wrksrc="$pkgname-$pkgname-$version"
make_build_args+=" all"
make_build_args+=" docs"

case "$XBPS_TARGET_MACHINE" in
  arm*)
    export LIBUCONTEXT_ARCH="arm"
    ;;
  i686*)
    export LIBUCONTEXT_ARCH="x86"
    ;;
  ppc64*)
    export LIBUCONTEXT_ARCH="ppc64"
    ;;
  ppc*)
    export LIBUCONTEXT_ARCH="ppc"
    ;;
  mips*)
    export LIBUCONTEXT_ARCH="mips"
    ;;
  *)
    export LIBUCONTEXT_ARCH="${XBPS_TARGET_MACHINE%%-musl}"
    ;;
esac

do_build() {
  case "$XBPS_TARGET_MACHINE" in
    i686*)
      vsed \
        -i \
        -e "s;__i686.get_pc_thunk.bx;i686_get_pc_thunk_bx;g" \
        arch/x86/startcontext.S
      ;;
  esac
  make \
    ARCH="$LIBUCONTEXT_ARCH"
}

do_check() {
  make \
    ARCH="$LIBUCONTEXT_ARCH" \
    check
}

do_install() {
  make \
    ARCH="$LIBUCONTEXT_ARCH" \
    DESTDIR="$DESTDIR" \
    install_docs
}

post_install() {
  vlicense LICENSE
}

libucontext-devel_package() {
  depends="libucontext>=${version}_$revision"
  short_desc+=" - development files"
  pkg_install() {
    vmove "usr/lib/*.so"
    vmove "usr/lib/*.a"
    vmove usr/share/man
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="libucontext"
version=0.9.0
revision=1
short_desc="Compatibility layer providing ucontext functions"
archs="*-musl"
homepage="https://code.foxkit.us/adelie/libucontext"
license="ISC"
distfiles="https://distfiles.adelielinux.org/source/libucontext/$pkgname-$version.tar.xz"
checksum="0d53a415a307ef175153bbe60a572c940a922cb736ce13530b666e7ec2795d68"

case "$XBPS_TARGET_MACHINE" in
  arm*)
    export LIBUCONTEXT_ARCH="arm"
    ;;
  i686*)
    export LIBUCONTEXT_ARCH="x86"
    ;;
  ppc64*)
    export LIBUCONTEXT_ARCH="ppc64"
    ;;
  *)
    export LIBUCONTEXT_ARCH="${XBPS_TARGET_MACHINE%%-musl}"
    ;;
esac

do_build() {
  case "$XBPS_TARGET_MACHINE" in
    i686*)
      vsed \
        -i \
        -e "s;__i686.get_pc_thunk.bx;i686_get_pc_thunk_bx;g" \
        arch/x86/startcontext.S
      ;;
  esac
  make \
    ARCH="$LIBUCONTEXT_ARCH"
}

do_check() {
  make \
    ARCH="$LIBUCONTEXT_ARCH" \
    check
}

do_install() {
  make \
    ARCH="$LIBUCONTEXT_ARCH" \
    DESTDIR="$DESTDIR/usr" \
    install
}

post_install() {
  vlicense LICENSE
}

libucontext-devel_package() {
  depends="libucontext>=${version}_$revision"
  short_desc+=" - development files"
  pkg_install() {
    vmove "usr/lib/*.so"
    vmove "usr/lib/*.a"
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

maintainer="nox"
pkgname="ncurses"
version=6.1
revision=5
short_desc="System V Release 4.0 curses emulation library"
depends="ncurses-base-${version}_$revision"
if [[ -n "$CROSS_BUILD" ]]; then
  # needs host tic(1)
  hostmakedepends="ncurses"
fi
homepage="http://www.gnu.org/software/ncurses/"
license="MIT"
distfiles="$GNU_SITE/ncurses/$pkgname-$version.tar.gz"
checksum="aa057eeeb4a14d470101eff4597d5833dcef5965331be3528c08d99cebaa0d17"
configure_args="--enable-big-core"
bootstrap="yes"

do_configure() {
  export CFLAGS="$CFLAGS -fPIC"
  export BUILD_CFLAGS="$BUILD_CFLAGS -fPIC"

  mkdir -p ncurses-build
  mkdir -p ncursesw-build

  cd "$wrksrc/ncursesw-build"
  # widec build
  ../configure \
    $configure_args \
    --enable-ext-colors \
    --enable-pc-files \
    --enable-widec \
    --with-manpage-format=normal \
    --with-manpage-symlinks \
    --with-pkg-config-libdir="/usr/lib/pkgconfig" \
    --with-shared \
    --without-ada \
    --without-debug \
    --without-tests \
    BUILD_CFLAGS="$BUILD_CFLAGS" \
    ac_cv_path_ac_pt_PKG_CONFIG="/usr/bin/pkg-config"

  cd "$wrksrc/ncurses-build"
  # non-widec build
  ../configure \
    $configure_args \
    --enable-pc-files \
    --with-pkg-config-libdir="/usr/lib/pkgconfig" \
    --with-shared \
    --without-ada \
    --without-debug \
    --without-tests \
    BUILD_CFLAGS="$BUILD_CFLAGS" \
    ac_cv_path_ac_pt_PKG_CONFIG="/usr/bin/pkg-config"
}

do_build() {
  cd "$wrksrc/ncursesw-build"
  make "$makejobs"

  cd "$wrksrc/ncurses-build"
  make "$makejobs"
}

do_install() {
  vlicense COPYING

  cd "$wrksrc/ncursesw-build"
  make DESTDIR="$DESTDIR" install

  # fool packages looking to link to non-wide-character ncurses libraries
  for lib in curses \
             form \
             menu \
             ncurses \
             panel; do
    rm -f "$DESTDIR/usr/lib/lib$lib.so"
    echo "INPUT(-l${lib}w)" >"$DESTDIR/usr/lib/lib$lib.so"
    chmod 755 "$DESTDIR/usr/lib/lib$lib.so"
    ln -sf "lib${lib}w.a" "$DESTDIR/usr/lib/lib$lib.a"
  done
  ln -sf libncurses++w.a "$DESTDIR/usr/lib/libncurses++.a"

  # some packages look for -lcurses during build
  rm -f "$DESTDIR/usr/lib/libcursesw.so"
  echo "INPUT(-lncursesw)" >"$DESTDIR/usr/lib/libcursesw.so"
  chmod 755 "$DESTDIR/usr/lib/libcursesw.so"
  ln -sf libncurses.so "$DESTDIR/usr/lib/libcurses.so"
  ln -sf libncursesw.a "$DESTDIR/usr/lib/libcursesw.a"
  ln -sf libncurses.a "$DESTDIR/usr/lib/libcurses.a"

  # non-widec compatibility library
  cd "$wrksrc/ncurses-build"
  install -Dm 755 "lib/libncurses.so.$version" "$DESTDIR/usr/lib/libncurses.so.$version"

  # create compat symlinks
  for f in form \
           menu \
           ncurses \
           panel; do
    ln -sfr "$DESTDIR/usr/lib/lib${f}w.so.6" "$DESTDIR/usr/lib/lib${f}w.so.5"
  done

  # remove broken symlink
  rm -f "$DESTDIR/usr/lib/terminfo"

  ln -sf ncursesw6-config "$DESTDIR/usr/bin/ncursesw5-config"
  ln -sf ncursesw6-config "$DESTDIR/usr/bin/ncurses5-config"
}

ncurses-libs_package() {
  shlib_provides+=" libformw.so.5"
  shlib_provides+=" libmenuw.so.5"
  shlib_provides+=" libncursesw.so.5"
  shlib_provides+=" libpanelw.so.5"
  short_desc+=" - shared libraries"
  pkg_install() {
    vmove "usr/lib/*.so.*"
  }
}

ncurses-devel_package() {
  depends="ncurses-libs-${version}_$revision"
  short_desc+=" - development files"
  pkg_install() {
    vmove "usr/bin/ncurses*-config"
    vmove usr/include
    vmove usr/lib/pkgconfig
    vmove "usr/lib/*.a"
    vmove "usr/lib/*.so"
    vmove usr/share/man/man3
    vmove usr/share/man/man1/ncursesw6-config.1
  }
}

ncurses-base_package() {
  short_desc+=" - base terminfo files"
  archs="noarch"
  pkg_install() {
    cat "$FILESDIR/base-files" | while read line; do
      vmove "$line"
    done
  }
}

ncurses-term_package() {
  depends="ncurses-base-${version}_$revision"
  short_desc+=" - full terminal descriptions"
  archs="noarch"
  pkg_install() {
    vmove usr/share/tabset
    vmove usr/share/terminfo
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

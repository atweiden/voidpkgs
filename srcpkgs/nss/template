maintainer="nox"
pkgname="nss"
version=3.49.1
revision=1
_nsprver=4.24
short_desc="Mozilla Network Security Services"
depends="nspr>=$_nsprver"
makedepends+=" nspr-devel"
makedepends+=" sqlite-devel"
makedepends+=" zlib-devel"
hostmakedepends="perl"
homepage="https://www.mozilla.org/projects/security/pki/nss"
license="MPL-2.0"
distfiles="$MOZILLA_SITE/security/nss/releases/NSS_${version//\./_}_RTM/src/nss-$version.tar.gz"
checksum="d9aa42e49e02bb0dc0a2f164604cfc718e11a2a06ddb266cd676376ac21b026e"

do_build() {
  # respect LDFLAGS
  vsed \
    -i \
    -e 's/\$(MKSHLIB) -o/\$(MKSHLIB) \$(LDFLAGS) -o/g' \
    nss/coreconf/rules.mk

  export BUILD_OPT=1
  export FREEBL_NO_DEPEND=1
  export LIBRUNPATH=
  export NATIVE_CC="$BUILD_CC"
  export NATIVE_FLAGS="$BUILD_CFLAGS"
  export NSS_ENABLE_ECC=1
  export NSS_ENABLE_WERROR=0
  export NSS_USE_SYSTEM_SQLITE=1

  case "$XBPS_MACHINE" in
    aarch64*|x86_64*|ppc64*)
      _native_use64="USE_64=1"
      ;;
  esac

  cd nss
  # build nsinstall for host
  make \
    LD="$BUILD_LD" \
    LDFLAGS="$BUILD_LDFLAGS" \
    $_native_use64 \
    -C coreconf

  if [[ -n "$CROSS_BUILD" ]]; then
    case "$XBPS_TARGET_MACHINE" in
      aarch64*)
        _ARCH="aarch64"
        _target_use64="USE_64=1"
        CFLAGS+=" -DNS_PTR_GT_32"
        ;;
      ppc64*)
        _ARCH="ppc64"
        _target_use64="USE_64=1"
        CFLAGS+=" -DNS_PTR_GT_32"
        ;;
      armv7*)
        _ARCH="arm"
        CFLAGS+=" -mfpu=neon"
        CXXFLAGS+=" -mfpu=neon"
        ;;
      arm*)
        _ARCH="arm"
        ;;
      mips*)
        _ARCH="mips"
        ;;
      ppc|ppc-musl)
        _ARCH="ppc"
        ;;
      *)
        msg_error "$pkgver: unknown target machine\n"
        ;;
    esac
    # ... and then copy it to $wrksrc
    find "$wrksrc" -type f -name nsinstall -exec cp {} "$wrksrc" \;
    make clean

    export NSPR_INCLUDE_DIR="$XBPS_CROSS_BASE/usr/include/nspr"
    export NSPR_LIB_DIR="$XBPS_CROSS_BASE/usr/lib"
    export XCFLAGS="$CFLAGS"

    make \
      CC="$CC" \
      CCC="$CXX" \
      CROSS_COMPILE=1 \
      NSINSTALL="$wrksrc/nsinstall" \
      OS_TEST="$_ARCH" \
      RANLIB="$RANLIB" \
      $_target_use64 \
      -C lib/dbm
    make \
      CC="$CC" \
      CCC="$CXX" \
      CROSS_COMPILE=1 \
      NSINSTALL="$wrksrc/nsinstall" \
      OS_TEST="$_ARCH" \
      RANLIB="$RANLIB" \
      $_target_use64
  else
    # native build
    export NSPR_INCLUDE_DIR="/usr/include/nspr"
    export NSPR_LIB_DIR="/usr/lib"
    export XCFLAGS="$CFLAGS"

    make \
      $_native_use64 \
      -C lib/dbm
    make \
      $_native_use64
  fi
}

do_check() {
  export BUILD_OPT=1
  export FREEBL_NO_DEPEND=1
  export LIBRUNPATH=
  export NATIVE_CC="$BUILD_CC"
  export NATIVE_FLAGS="$BUILD_CFLAGS"
  # we couldn't run test in cross compile
  export NSPR_INCLUDE_DIR="/usr/include/nspr"
  export NSPR_LIB_DIR="/usr/lib"
  export NSS_ENABLE_ECC=1
  export NSS_ENABLE_WERROR=0
  export NSS_USE_SYSTEM_SQLITE=1
  export XCFLAGS="$CFLAGS"
  case "$XBPS_MACHINE" in
    aarch64*|x86_64*|ppc64*)
      _use_64="USE_64=1"
      ;;
  esac
  cd nss/tests
  env \
    DOMSUF="localdomain" \
    HOST="localhost" \
    "$_use_64" \
    ./all.sh
}

do_install() {
  vmkdir usr/lib/pkgconfig
  vmkdir usr/bin
  vmkdir usr/include/nss

  NSS_VMAJOR="$(grep "#define.*NSS_VMAJOR" nss/lib/nss/nss.h | awk '{print $3}')"
  NSS_VMINOR="$(grep "#define.*NSS_VMINOR" nss/lib/nss/nss.h | awk '{print $3}')"
  NSS_VPATCH="$(grep "#define.*NSS_VPATCH" nss/lib/nss/nss.h | awk '{print $3}')"

  sed \
    "$FILESDIR/nss.pc.in" \
    -e "s,%libdir%,/usr/lib,g" \
    -e "s,%prefix%,/usr,g" \
    -e "s,%exec_prefix%,/usr/bin,g" \
    -e "s,%includedir%,/usr/include/nss,g" \
    -e "s,%NSPR_VERSION%,$_nsprver,g" \
    -e "s,%NSS_VERSION%,$version,g" \
    > "$DESTDIR/usr/lib/pkgconfig/nss.pc"

  ln -sf nss.pc "$DESTDIR/usr/lib/pkgconfig/mozilla-nss.pc"
  chmod 644 "$DESTDIR/usr/lib/pkgconfig"/*.pc

  sed \
    "$FILESDIR/nss-config.in" \
    -e "s,@libdir@,/usr/lib,g" \
    -e "s,@prefix@,/usr/bin,g" \
    -e "s,@exec_prefix@,/usr/bin,g" \
    -e "s,@includedir@,/usr/include/nss,g" \
    -e "s,@MOD_MAJOR_VERSION@,$NSS_VMAJOR,g" \
    -e "s,@MOD_MINOR_VERSION@,$NSS_VMINOR,g" \
    -e "s,@MOD_PATCH_VERSION@,$NSS_VPATCH,g" \
    > "$DESTDIR/usr/bin/nss-config"
  chmod 755 "$DESTDIR/usr/bin/nss-config"

  for f in libfreebl3.so \
           libnss3.so \
           libnssckbi.so \
           libnssdbm3.so \
           libnssutil3.so \
           libsmime3.so \
           libsoftokn3.so \
           libssl3.so; do
    install -m 755 dist/*.OBJ/lib/"$f" "$DESTDIR/usr/lib"
  done

  install -m 644 dist/*.OBJ/lib/libcrmf.a "$DESTDIR/usr/lib"

  for f in certutil \
           cmsutil \
           crlutil \
           modutil \
           pk12util \
           shlibsign \
           signtool \
           signver \
           ssltap; do
    install -m 755 dist/*.OBJ/bin/"$f" "$DESTDIR/usr/bin"
  done

  install -m 644 dist/public/nss/*.h "$DESTDIR/usr/include/nss"
}

nss-devel_package() {
  unset depends
  depends+=" nspr-devel>=$_nsprver"
  depends+=" nss>=${version}_$revision"
  short_desc+=" - development files"
  pkg_install() {
    vmove usr/bin/nss-config
    vmove usr/lib/pkgconfig
    vmove usr/include
    vmove "usr/lib/*.a"
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

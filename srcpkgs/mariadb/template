maintainer="nox"
pkgname="mariadb"
version=10.5.10
revision=1
short_desc="Fast SQL database server, drop-in replacement for MySQL"
depends="mariadb-client"
makedepends+=" boost-devel"
makedepends+=" gnutls-devel"
makedepends+=" libaio-devel"
makedepends+=" libatomic-devel"
makedepends+=" ncurses-devel"
makedepends+=" pam-devel"
makedepends+=" pcre2-devel"
makedepends+=" zlib-devel"
checkdepends="perl"
hostmakedepends+=" bison"
hostmakedepends+=" flex"
hostmakedepends+=" perl"
hostmakedepends+=" pkg-config"
homepage="https://mariadb.com/"
license="GPL-2.0-only"
distfiles="http://archive.mariadb.org/mariadb-$version/source/$pkgname-$version.tar.gz"
checksum="a5ff32f9fcaaf26bf5cba94accc7b246d2d5eb75710d027e40122df6bac0babb"
conf_files="/etc/mysql/my.cnf"
build_style="cmake"
configure_args+=" -DBUILD_CONFIG=mysql_release"
configure_args+=" -DDEFAULT_CHARSET=utf8"
configure_args+=" -DDEFAULT_COLLATION=utf8_general_ci"
configure_args+=" -DENABLED_LOCAL_INFILE=ON"
configure_args+=" -DINSTALL_DOCDIR=share/mysql/docs"
configure_args+=" -DINSTALL_DOCREADMEDIR=share/mysql"
configure_args+=" -DINSTALL_INCLUDEDIR=include/mysql"
configure_args+=" -DINSTALL_INFODIR=share/mysql/docs"
configure_args+=" -DINSTALL_MANDIR=share/man"
configure_args+=" -DINSTALL_MYSQLSHAREDIR=share/mysql"
configure_args+=" -DINSTALL_PLUGINDIR=lib/mysql/plugin"
configure_args+=" -DINSTALL_SCRIPTDIR=bin"
configure_args+=" -DINSTALL_SHAREDIR=share/mysql"
configure_args+=" -DINSTALL_SUPPORTFILESDIR=share/mysql"
configure_args+=" -DMYSQL_DATADIR=/var/lib/mysql"
configure_args+=" -DMYSQL_UNIX_ADDR=/run/mysqld/mysqld.sock"
configure_args+=" -DPLUGIN_BLACKHOLE=YES"
configure_args+=" -DPLUGIN_PARTITION=YES"
configure_args+=" -DPLUGIN_TOKUDB=NO"
configure_args+=" -DSTACK_DIRECTION=1"
configure_args+=" -DWITH_EMBEDDED_SERVER=ON"
configure_args+=" -DWITH_EXTRA_CHARSETS=complex"
configure_args+=" -DWITH_LIBARCHIVE=system"
configure_args+=" -DWITH_LIBWRAP=OFF"
configure_args+=" -DWITH_PCRE=system"
configure_args+=" -DWITH_READLINE=ON"
configure_args+=" -DWITH_SSL=system"
configure_args+=" -DWITH_SYSTEMD=no"
configure_args+=" -DWITH_ZLIB=system"
system_accounts="mysql"
mysql_homedir="/var/lib/mysql"
make_dirs+=" /var/lib/mysql 0700 mysql mysql"
make_dirs+=" /usr/lib/mysql/plugin/auth_pam_tool_dir 0700 mysql root"
lib32disabled="yes"
provides="mysql-${version}_$revision"
replaces="mysql>=0"

post_patch() {
  case "$XBPS_TARGET_MACHINE" in
    *-musl)
      patch -p0 -i "$FILESDIR/musl-have-stacktrace.patch"
      patch -p0 -i "$FILESDIR/musl-ppc-remove-glibc-dep.patch"
      ;;
  esac
}

do_check() {
  cd build
  if [[ "$XBPS_CHECK_PKGS" == "full" ]]; then
    if ! [[ -n "$CROSS_BUILD" ]]; then
      mem="--mem"
    fi
    # NOTE: removed cross compilation support here
    perl mysql-test/mtr --parallel="$XBPS_MAKEJOBS" "$mem" --force --max-test-fail=40
  else
    CTEST_OUTPUT_ON_FAILURE=TRUE ctest -E "(conc336|bulk1|performance|basic-t|fetch|charset|logs|cursor|errors|view|ps|ps_bugs|sp|result|connection|misc|ps_new|thread|features-10_2|async|test-connect)"
  fi
}

post_install() {
  # remove unneeded stuff
  rm -rf "$DESTDIR/usr"/{sql-bench,mysql-test,data}
  rm -f "$DESTDIR/usr/share/man/man1/mysql-test-run.pl.1"
  rm -f "$DESTDIR/usr/bin/mytop"

  vmkdir usr/lib/security
  vmkdir etc/security
  mv "$DESTDIR/usr/share/pam_user_map.so" "$DESTDIR/usr/lib/security/"
  mv "$DESTDIR/usr/share/user_map.conf" "$DESTDIR/etc/security/"

  vsv mysqld
}

libmariadbclient_package() {
  short_desc+=" - client library"
  provides="libmysqlclient-${version}_$revision"
  replaces="libmysqlclient>=0"
  pkg_install() {
    vmove "usr/lib/libmariadb*.so.*"
  }
}

libmariadbclient-devel_package() {
  unset depends
  depends+=" libatomic-devel"
  depends+=" libmariadbclient>=${version}_$revision"
  provides="libmysqlclient-devel-${version}_$revision"
  replaces="libmysqlclient-devel>=0"
  short_desc+=" - client development files"
  pkg_install() {
    vmove usr/bin/mysql_config
    vmove usr/share/man/man1/mysql_config.1
    vmove usr/include
    vmove "usr/lib/*.a"
    vmove "usr/lib/*.so"
  }
}

mariadb-client_package() {
  depends="perl"
  provides="mysql-client-${version}_$revision"
  replaces="mysql-client>=0"
  short_desc+=" - client binaries"
  pkg_install() {
    for f in innochecksum \
             innotop \
             myisam_ftdump \
             mysql \
             mysql_client_test \
             mysql_client_test_embedded \
             mysql_find_rows \
             mysql_fix_extensions \
             mysql_upgrade \
             mysql_waitpid \
             mysql_zap \
             mysqlaccess \
             mysqladmin \
             mysqlanalyze \
             mysqlbinlog \
             mysqlbug \
             mysqlcheck \
             mysqldump \
             mysqldumpslow \
             mysqlhotcopy \
             mysqlimport \
             mysqlmanager \
             mysqloptimize \
             mysqlrepair \
             mysqlreport \
             mysqlshow \
             mysqlslap \
             mysqltest \
             mysqltest_embedded; do
      if [[ -f "$DESTDIR/usr/bin/$f" ]]; then
        vmove "usr/bin/$f"
      elif [[ -f "$DESTDIR/usr/sbin/$f" ]]; then
        vmove "usr/sbin/$f"
      fi
      if [[ -f "$DESTDIR/usr/share/man/man1/$f.1" ]]; then
        vmove "usr/share/man/man1/$f.1"
      elif [[ -f "$DESTDIR/usr/share/man/man8/$f.8" ]]; then
        vmove "usr/share/man/man8/$f.8"
      fi
    done
  }
}

libmysqlclient_package() {
  build_style="meta"
  depends="libmariadbclient"
  short_desc="MySQL - (transitional dummy package)"
}

libmysqlclient-devel_package() {
  build_style="meta"
  depends="libmariadbclient-devel"
  short_desc="MySQL - (transitional dummy package)"
}

mysql-client_package() {
  build_style="meta"
  depends="mariadb"
  short_desc="MySQL - (transitional dummy package)"
}

mysql_package() {
  build_style="meta"
  depends="mariadb"
  short_desc="MySQL - (transitional dummy package)"
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

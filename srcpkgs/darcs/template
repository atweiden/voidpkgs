maintainer="nox"
pkgname="darcs"
version=2.14.2
revision=3
short_desc="Change-focused cross-platform version control system"
makedepends+=" libcurl-devel"
makedepends+=" ncurses-devel"
makedepends+=" zlib-devel"
hostmakedepends="unzip"
homepage="http://darcs.net/"
license="GPL-2.0-or-later"
distfiles="http://hackage.haskell.org/package/$pkgname-$version/$pkgname-$version.tar.gz"
checksum="65d160a43874960dcba114c0b74d9c7b25d098486f515655502f42ff0c22a27e"
build_style="haskell-stack"
nopie_files="/usr/bin/darcs"
nocross="yes"

do_configure() {
  vsed \
    -i \
    -e 's/< *0.5/<1/' \
    -e 's/< *2.13/<3/' \
    -e 's/< *4.13/<5/' \
    -e 's/< *1.3/<2/' \
    -e 's/< *2/<4/' \
    "$pkgname.cabal"
  vsed \
    -i \
    -e '/sDistHook = /,+14d' \
    Setup.hs
  vsed \
    -i \
    -e '/fail\ \ \ = failSM/i instance MonadFail SM where' \
    src/Darcs/Patch/ReadMonads.hs
  vsed \
    -i \
    -e 's/fail \$/error $/' \
    src/Darcs/Util/Tree/Monad.hs \
    src/Darcs/Repository/Diff.hs \
    src/Darcs/Patch/Prim/V1/Apply.hs
  vsed \
    -i \
    -e 's/Monad m => PatchInfoAnd/MonadFail m => PatchInfoAnd/' \
    src/Darcs/Patch/PatchInfoAnd.hs
  vsed \
    -i \
    -e 's/fail /error /' \
    src/Darcs/Patch/Depends.hs \
    src/Darcs/Patch/Match.hs \
    src/Darcs/Repository/Match.hs
  vsed \
    -i \
    -e '/fail _ /i instance  MonadFail Perhaps where' \
    src/Darcs/Patch/{,Prim}/V1/Commute.hs
}

post_install() {
  vinstall contrib/darcs_completion 644 usr/share/bash-completion/completions
  cd .stack-work/dist/*/*/build/darcs
  vman darcs.1
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

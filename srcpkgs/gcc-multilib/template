_triplet="x86_64-unknown-linux-gnu"
_majorver=8.2

maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="gcc-multilib"
version=$_majorver.0
revision=2
short_desc="The GNU C Compiler (multilib files)"
only_for_archs="x86_64"
homepage="http://gcc.gnu.org"
license="GFDL-1.2, GPL-3, LGPL-2.1"
depends+=" gcc>=$_majorver"
depends+=" glibc-devel-32bit"
depends+=" libatomic-devel-32bit>=$_majorver"
depends+=" libgcc-32bit>=$_majorver"
depends+=" libgomp-devel-32bit>=$_majorver"
depends+=" libitm-devel-32bit>=$_majorver"
depends+=" libmpx-devel-32bit>=$_majorver"
depends+=" libsanitizer-devel-32bit>=$_majorver"
depends+=" libssp-devel-32bit>=$_majorver"
depends+=" libvtv-devel-32bit>=$_majorver"
depends+=" zlib-32bit"
makedepends+=" glibc-32bit"
makedepends+=" glibc-devel-32bit"
makedepends+=" isl15-devel"
makedepends+=" libfl-devel"
makedepends+=" libmpc-devel"
makedepends+=" zlib-devel"
hostmakedepends+=" flex"
hostmakedepends+=" perl"
hostmakedepends+=" unzip"
hostmakedepends+=" zip"
distfiles="$GNU_SITE/gcc/gcc-$version/gcc-$version.tar.xz"
checksum="196c3c04ba2613f893283977e6011b2345d1cd1af9abeac58e916b1aab3e0080"
wrksrc="gcc-$version"

do_configure() {
  ldconfig &>/dev/null

  # _FORTIFY_SOURCE needs an optimization level
  sed -i "/ac_cpp=/s/\$CPPFLAGS/\$CPPFLAGS -O2/" {gcc,libiberty}/configure
  # hack! some configure tests for header files using "$CPP $CPPFLAGS"
  sed -i "/ac_cpp=/s/\$CPPFLAGS/\$CPPFLAGS -O2/" {libiberty,gcc}/configure

  ./configure                      \
    --disable-bootstrap            \
    --disable-libstdcxx-pch        \
    --disable-rpath                \
    --disable-target-libiberty     \
    --enable-__cxa_atexit          \
    --enable-checking=release      \
    --enable-clocale="gnu"         \
    --enable-gnu-unique-object     \
    --enable-languages="c,c++,lto" \
    --enable-libstdcxx-time        \
    --enable-linker-build-id       \
    --enable-lto                   \
    --enable-multilib              \
    --enable-shared                \
    --enable-threads=posix         \
    --enable-tls                   \
    --infodir="/usr/share/info"    \
    --libdir="/usr/lib"            \
    --libexecdir="/usr/lib"        \
    --mandir="/usr/share/man"      \
    --prefix="/usr"                \
    --with-isl                     \
    --with-linker-hash-style="gnu" \
    --with-system-zlib
}

do_build() {
  make "$makejobs"
}

do_install() {
  # install to a tempdir and then only copy relevant files
  if [[ "$XBPS_TARGET_MACHINE" == "x86_64" ]]; then
    vmkdir usr/lib
    cd "$DESTDIR/usr"
    ln -sf lib lib64
  fi

  cd "$wrksrc"
  make DESTDIR="$wrksrc/$pkgname-build" install

  # make version a symlink of major version to make all versions from
  # the same series work automagically
  vmkdir "usr/include/c++/$_majorver/$_triplet"
  vmkdir "usr/lib/gcc/$_triplet/$_majorver"

  cp -a "$wrksrc/$pkgname-build/usr/lib/gcc/$_triplet/$version/32" \
    "$DESTDIR/usr/lib/gcc/$_triplet/$_majorver/"
  cp -a "$wrksrc/$pkgname-build/usr/include/c++/$version/$_triplet/32" \
    "$DESTDIR/usr/include/c++/$_majorver/$_triplet"

  vinstall "$wrksrc/host-$_triplet/gcc/specs" 644 "usr/lib/gcc/$_triplet/$_majorver"

  rm -f "$DESTDIR/usr/lib64"
}

gcc-objc-multilib_package() {
  unset depends
  depends+=" gcc-multilib>=$_majorver"
  depends+=" gcc-objc>=$_majorver"
  depends+=" libobjc-devel-32bit>=$_majorver"
  short_desc="The GNU Objective-C compiler (multilib files)"
  build_style="meta"
}

# vim: set filetype=sh foldmethod=marker foldlevel=0:

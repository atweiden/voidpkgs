maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="odroid-c2-uboot"
version=v2015.01
revision=4
_gitrev="f416a769454b89c39d5b217d28bd3c9f5d1594df"
short_desc="U-Boot for ODROID-C2"
only_for_archs+=" aarch64"
only_for_archs+=" aarch64-musl"
hostmakedepends="bc"
homepage="https://github.com/hardkernel/u-boot"
license="GPL-2"
distfiles="https://github.com/hardkernel/u-boot/archive/$_gitrev.tar.gz>$pkgname-$version.tar.gz"
checksum="6b5fb2c5f278cdeaf8361fbcb349a75ffa551db3f993143f87cefd32fdc38874"
conf_files="/boot/boot.ini"
wrksrc="u-boot-$_gitrev"

make_build_args="ARCH=arm"
if [[ -n "$CROSS_BUILD" ]]; then
  make_build_args+=" CROSS_COMPILE=$XBPS_CROSS_TRIPLET-"
else
  make_build_args+=" HOSTARCH=arm"
fi

post_extract() {
  cp include/linux/compiler-gcc4.h include/linux/compiler-gcc8.h
  # musl hack
  touch include/stddef.h
  sed \
    -i \
    -e '1itypedef unsigned long ulong;' \
    include/image.h \
    tools/mkimage.h \
    tools/proftool.c
}

do_configure() {
  unset CFLAGS
  unset CXXFLAGS
  unset LDFLAGS
  make "$make_build_args" distclean
  make "$make_build_args" odroidc2_config
}

do_build() {
  unset CFLAGS
  unset CXXFLAGS
  unset LDFLAGS
  make "$makejobs" "$make_build_args"
}

do_install() {
  vmkdir boot
  vinstall sd_fuse/bl1.bin.hardkernel 644 boot
  vinstall sd_fuse/u-boot.bin 644 boot
  vinstall sd_fuse/sd_fusing.sh 755 boot
  vinstall "$FILESDIR/boot.ini" 644 boot
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="glib"
version=2.58.2
revision=1
makedepends+=" dbus-devel"
makedepends+=" elfutils-devel"
makedepends+=" libffi-devel"
makedepends+=" libmount-devel"
makedepends+=" pcre-devel"
makedepends+=" zlib-devel"
checkdepends+=" desktop-file-utils"
checkdepends+=" shared-mime-info"
checkdepends+=" tzdata"
hostmakedepends+=" autoconf"
hostmakedepends+=" automake"
hostmakedepends+=" docbook-xsl"
hostmakedepends+=" libtool"
hostmakedepends+=" libxslt"
hostmakedepends+=" m4"
hostmakedepends+=" perl"
hostmakedepends+=" pkg-config"
hostmakedepends+=" python3"
short_desc="The GNU library of C routines"
homepage="https://wiki.gnome.org/Projects/GLib"
license="LGPL-2.1-or-later"
changelog="https://gitlab.gnome.org/GNOME/glib/raw/master/NEWS"
distfiles="$GNOME_SITE/glib/${version%.*}/$pkgname-$version.tar.xz"
checksum="c7b24ed6536f1a10fc9bce7994e55c427b727602e78342821f1f07fb48753d4b"
build_style="gnu-configure"
configure_args+=" --disable-fam"
configure_args+=" --enable-libelf"
configure_args+=" --enable-static"
configure_args+=" --with-pcre=system"

if [[ -n "$CROSS_BUILD" ]]; then
  hostmakedepends+=" glib-devel"
  case "$XBPS_TARGET_MACHINE" in
    mips*)
      # it seems common/environment/configure/autoconf_cache/mips-linux is not read?
      configure_args+=" glib_cv_stack_grows=no"
      configure_args+=" glib_cv_rtldglobal_broken=no"
      configure_args+=" glib_cv_uscore=no"
      ;;
  esac
fi

pre_configure() {
  ./autogen.sh
}

libglib-devel_package() {
  depends+=" $makedepends"
  depends+=" glib>=${version}_$revision"
  short_desc+=" - development files"
  pkg_install() {
    vmove usr/include
    vmove usr/lib/glib-2.0
    vmove usr/lib/pkgconfig
    vmove "usr/lib/*.a"
    vmove "usr/lib/*.so"
  }
}

glib-devel_package() {
  depends+=" libglib-devel>=${version}_$revision"
  depends+=" python3"
  short_desc+=" - development files"
  pycompile_version="$py3_ver"
  pycompile_dirs+=" usr/share/glib-2.0/codegen"
  pycompile_dirs+=" usr/share/glib-2.0/gdb"
  pkg_install() {
    vmove usr/bin/gdbus-codegen
    vmove usr/bin/glib-compile-resources
    vmove usr/bin/glib-genmarshal
    vmove usr/bin/glib-gettextize
    vmove usr/bin/glib-mkenums
    vmove usr/bin/gtester
    vmove usr/bin/gtester-report
    vmove usr/share/man/man1/gdbus-codegen.1
    vmove usr/share/man/man1/glib-compile-resources.1
    vmove usr/share/man/man1/glib-genmarshal.1
    vmove usr/share/man/man1/glib-gettextize.1
    vmove usr/share/man/man1/glib-mkenums.1
    vmove usr/share/man/man1/gtester-report.1
    vmove usr/share/man/man1/gtester.1
    for f in aclocal \
             gdb \
             glib-2.0; do
      vmove "usr/share/$f"
    done
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

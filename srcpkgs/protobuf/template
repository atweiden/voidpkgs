maintainer="nox"
pkgname="protobuf"
version=3.7.1
revision=2
short_desc="Protocol buffers compiler"
makedepends="zlib-devel"
hostmakedepends+=" automake"
hostmakedepends+=" libtool"
hostmakedepends+=" pkg-config"
homepage="https://developers.google.com/protocol-buffers/"
license="BSD-3-Clause"
changelog="https://github.com/protocolbuffers/protobuf/raw/master/CHANGES.txt"
distfiles="https://github.com/protocolbuffers/protobuf/archive/v$version.tar.gz>$pkgname-$version.tar.gz"
checksum="f1748989842b46fa208b2a6e4e2785133cfcc3e4d43c17fecb023733f0f5443f"
build_style="gnu-configure"

if [[ -n "$CROSS_BUILD" ]]; then
  # needs host protoc
  hostmakedepends+=" protobuf"
  configure_args+=" --with-protoc=/usr/bin/protoc"
fi

case "$XBPS_TARGET_MACHINE" in
  armv[56]*|mips*|ppc|ppc-musl)
    makedepends+=" libatomic-devel"
    LDFLAGS+=" -latomic"
    ;;
esac

pre_configure() {
  autoreconf -fi
}

post_install() {
  vlicense LICENSE
}

libprotobuf18_package() {
  short_desc="Protocol buffers C++ library"
  pkg_install() {
    vmove "usr/lib/libprotobuf.so.*"
    vlicense LICENSE
  }
}

libprotobuf-lite18_package() {
  short_desc="Protocol buffers C++ library (lite version)"
  pkg_install() {
    vmove "usr/lib/libprotobuf-lite.so.*"
    vlicense LICENSE
  }
}

libprotoc18_package() {
  short_desc="Protocol buffers compiler library"
  pkg_install() {
    vmove "usr/lib/libprotoc*.so.*"
    vlicense LICENSE
  }
}

libprotoc-devel_package() {
  depends="libprotoc18-${version}_$revision"
  short_desc="Protocol buffers compiler library - development files"
  pkg_install() {
    vmove usr/lib/libprotoc.a
    vmove usr/lib/libprotoc.so
    vmove usr/include/google/protobuf/compiler
  }
}

protobuf-devel_package() {
  depends+=" libprotobuf-lite18-${version}_$revision"
  depends+=" libprotobuf18-${version}_$revision"
  depends+=" zlib-devel"
  short_desc="Protocol buffers C++ library - development files"
  pkg_install() {
    vmove usr/include
    vmove usr/lib/libprotobuf.a
    vmove usr/lib/libprotobuf-lite.a
    vmove usr/lib/libprotobuf.so
    vmove usr/lib/libprotobuf-lite.so
    vmove usr/lib/pkgconfig
  }
}

protobuf-lite_package() {
  build_style="meta"
  short_desc="Protocol buffers C++ library (lite version)"
  depends="libprotobuf-lite18-${version}_$revision"
  archs="noarch"
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

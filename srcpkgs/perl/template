maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="perl"
version=5.30.1
revision=1
_perl_cross_version=1.3
short_desc="Practical Extraction and Report Language"
depends="less"
makedepends+=" bzip2-devel"
makedepends+=" db-devel"
makedepends+=" gdbm-devel"
makedepends+=" zlib-devel"
checkdepends+=" iana-etc"
checkdepends+=" perl-AnyEvent"
checkdepends+=" perl-Test-Pod"
checkdepends+=" procps-ng"
hostmakedepends="less"
homepage="https://www.perl.org"
license="Artistic-1.0-perl, GPL-1.0-or-later"
distfiles+=" https://www.cpan.org/src/5.0/perl-$version.tar.gz"
distfiles+=" https://github.com/arsv/perl-cross/releases/download/$_perl_cross_version/perl-cross-$_perl_cross_version.tar.gz"
checksum+=" bf3d25571ff1ee94186177c2cdef87867fd6a14aa5a84f0b1fb7bf798f42f964"
checksum+=" 49edea1ea2cd6c5c47386ca71beda8d150c748835781354dbe7f75b1df27e703"
build_style="gnu-configure"
disable_parallel_build="yes"
# XXX: before updating this package to a new major version, run
# $FILESDIR/provides.pl against $wrksrc to find the list of built-in
# packages
provides+=" perl-Archive-Tar-2.32_1"
provides+=" perl-Attribute-Handlers-1.01_1"
provides+=" perl-AutoLoader-5.74_1"
provides+=" perl-CPAN-2.22_1"
provides+=" perl-CPAN-Meta-2.150010_1"
provides+=" perl-CPAN-Meta-Requirements-2.140_1"
provides+=" perl-CPAN-Meta-YAML-0.018_1"
provides+=" perl-Carp-1.50_1"
provides+=" perl-Compress-Raw-Bzip2-2.084_1"
provides+=" perl-Compress-Raw-Zlib-2.084_1"
provides+=" perl-Config-Perl-V-0.32_1"
provides+=" perl-DB_File-1.843_1"
provides+=" perl-Data-Dumper-2.174_1"
provides+=" perl-Devel-PPPort-3.52_1"
provides+=" perl-Devel-SelfStubber-1.06_1"
provides+=" perl-Digest-1.17_01_1"
provides+=" perl-Digest-MD5-2.55_1"
provides+=" perl-Digest-SHA-6.02_1"
provides+=" perl-Dumpvalue-1.18_1"
provides+=" perl-Encode-3.01_1"
provides+=" perl-Env-1.04_1"
provides+=" perl-Exporter-5.73_1"
provides+=" perl-ExtUtils-CBuilder-0.280231_1"
provides+=" perl-ExtUtils-Constant-0.25_1"
provides+=" perl-ExtUtils-Install-2.14_1"
provides+=" perl-ExtUtils-MakeMaker-7.34_1"
provides+=" perl-ExtUtils-Manifest-1.72_1"
provides+=" perl-ExtUtils-ParseXS-3.40_1"
provides+=" perl-File-Fetch-0.56_1"
provides+=" perl-File-Path-2.16_1"
provides+=" perl-File-Temp-0.2309_1"
provides+=" perl-Filter-Simple-0.95_1"
provides+=" perl-Filter-Util-Call-1.59_1"
provides+=" perl-Getopt-Long-2.5_1"
provides+=" perl-HTTP-Tiny-0.076_1"
provides+=" perl-I18N-Collate-1.02_1"
provides+=" perl-I18N-LangTags-0.43_1"
provides+=" perl-IO-1.40_1"
provides+=" perl-IO-Compress-2.084_1"
provides+=" perl-IO-Socket-IP-0.39_1"
provides+=" perl-IO-Zlib-1.10_1"
provides+=" perl-IPC-Cmd-1.02_1"
provides+=" perl-IPC-SysV-2.07_1"
provides+=" perl-JSON-PP-4.02_1"
provides+=" perl-Locale-Maketext-1.29_1"
provides+=" perl-Locale-Maketext-Simple-0.21_01_1"
provides+=" perl-MIME-Base64-3.15_1"
provides+=" perl-Math-BigInt-1.999816_1"
provides+=" perl-Math-BigInt-FastCalc-0.5008_1"
provides+=" perl-Math-BigRat-0.2614_1"
provides+=" perl-Math-Complex-1.5901_1"
provides+=" perl-Memoize-1.03_01_1"
provides+=" perl-Module-CoreList-5.20191110_1"
provides+=" perl-Module-Load-0.34_1"
provides+=" perl-Module-Load-Conditional-0.68_1"
provides+=" perl-Module-Loaded-0.08_1"
provides+=" perl-Module-Metadata-1.000036_1"
provides+=" perl-NEXT-0.67_01_1"
provides+=" perl-Net-Ping-2.71_1"
provides+=" perl-Params-Check-0.38_1"
provides+=" perl-PathTools-3.78_1"
provides+=" perl-Perl-OSType-1.010_1"
provides+=" perl-PerlIO-via-QuotedPrint-0.08_1"
provides+=" perl-Pod-Checker-1.73_1"
provides+=" perl-Pod-Escapes-1.07_1"
provides+=" perl-Pod-Parser-1.63_1"
provides+=" perl-Pod-Perldoc-3.2801_1"
provides+=" perl-Pod-Simple-3.35_1"
provides+=" perl-Pod-Usage-1.69_1"
provides+=" perl-Safe-2.40_1"
provides+=" perl-Scalar-List-Utils-1.50_1"
provides+=" perl-Search-Dict-1.07_1"
provides+=" perl-SelfLoader-1.25_1"
provides+=" perl-Socket-2.027_1"
provides+=" perl-Storable-3.15_1"
provides+=" perl-Sys-Syslog-0.35_1"
provides+=" perl-Term-ANSIColor-4.06_1"
provides+=" perl-Term-Cap-1.17_1"
provides+=" perl-Term-Complete-1.403_1"
provides+=" perl-Term-ReadLine-1.17_1"
provides+=" perl-Test-1.31_1"
provides+=" perl-Test-Harness-3.42_1"
provides+=" perl-Test-Simple-1.302162_1"
provides+=" perl-Text-Abbrev-1.02_1"
provides+=" perl-Text-Balanced-2.03_1"
provides+=" perl-Text-ParseWords-3.30_1"
provides+=" perl-Text-Tabs-2013.0523_1"
provides+=" perl-Thread-Queue-3.13_1"
provides+=" perl-Thread-Semaphore-2.13_1"
provides+=" perl-Tie-File-1.02_1"
provides+=" perl-Tie-RefHash-1.39_1"
provides+=" perl-Time-HiRes-1.9760_1"
provides+=" perl-Time-Local-1.28_1"
provides+=" perl-Time-Piece-1.33_1"
provides+=" perl-Unicode-Collate-1.27_1"
provides+=" perl-Unicode-Normalize-1.26_1"
provides+=" perl-Win32-0.52_1"
provides+=" perl-Win32API-File-0.1203_1"
provides+=" perl-XSLoader-0.30_1"
provides+=" perl-autodie-2.29_1"
provides+=" perl-autouse-1.11_1"
provides+=" perl-base-2.27_1"
provides+=" perl-bignum-0.51_1"
provides+=" perl-constant-1.33_1"
provides+=" perl-encoding-warnings-0.13_1"
provides+=" perl-experimental-0.020_1"
provides+=" perl-if-0.0608_1"
provides+=" perl-lib-0.65_1"
provides+=" perl-libnet-3.11_1"
provides+=" perl-parent-0.237_1"
provides+=" perl-perlfaq-5.20190126_1"
provides+=" perl-podlators-5.006_1"
provides+=" perl-threads-2.22_1"
provides+=" perl-threads-shared-1.60_1"
provides+=" perl-version-0.9924_1"
for f in $provides; do
  replaces+=" $("$XBPS_UHELPER_CMD" getpkgname "$f")>=0"
done

post_extract() {
  cp -a "../perl-cross-$_perl_cross_version"/* .
  cp -a cnf/diffs/perl5-5.30.0 cnf/diffs/perl5-5.30.1
}

do_configure() {
  local _args
  _args+=" -Darchlib=/usr/lib/perl5/core_perl"
  _args+=" -Dd_sockaddr_in6=define"
  _args+=" -Dinc_version_list=none"
  _args+=" -Dman1dir=/usr/share/man/man1"
  _args+=" -Dman1ext=1p"
  _args+=" -Dman3dir=/usr/share/man/man3"
  _args+=" -Dman3ext=3p"
  _args+=" -Dprefix=/usr"
  _args+=" -Dprivlib=/usr/share/perl5/core_perl"
  _args+=" -Dscriptdir=/usr/bin"
  _args+=" -Dsitearch=/usr/lib/perl5/site_perl"
  _args+=" -Dsitelib=/usr/share/perl5/site_perl"
  _args+=" -Duseshrplib"
  _args+=" -Dusesoname"
  _args+=" -Dusethreads"
  _args+=" -Dusevendorprefix"
  _args+=" -Dvendorarch=/usr/lib/perl5/vendor_perl"
  _args+=" -Dvendorlib=/usr/share/perl5/vendor_perl"
  _args+=" -Dvendorprefix=/usr"
  _args+=" -Dvendorscript=/usr/bin"
  if [[ -n "$CROSS_BUILD" ]]; then
    _args+=" --target=$XBPS_CROSS_TRIPLET"
  fi

  LDFLAGS+=" -pthread"

  # perl-cross autodetection fails
  # need perl -V:lseeksize = 8 (default on musl)
  case "$XBPS_TARGET_MACHINE" in
    i686|armv5tel|armv6l|armv7l|aarch64|ppc64le|ppc64|ppc)
      HOSTLDFLAGS+=" -pthread"
      export HOSTLDFLAGS
      CFLAGS+=" -DLARGE_FILE_SUPPORT64 "
      CFLAGS+=" -D_FILE_OFFSET_BITS=64"
      ;;
    *-musl)
      HOSTCFLAGS+=" -D_GNU_SOURCE"
      export HOSTCFLAGS
      HOSTLDFLAGS+=" -pthread"
      export HOSTLDFLAGS
      CFLAGS+=" -DNO_POSIX_2008_LOCALE"
      CFLAGS+=" -D_GNU_SOURCE"
      ;;
  esac

  export LD="$CC"

  ./configure \
    $_args \
    --prefix=/usr \
    -Dcccdlflags="-fPIC" \
    -Dccflags=" $CFLAGS " \
    -Dd_static_inline \
    -Dlddlflags="-shared $LDFLAGS" \
    -Dldflags="$LDFLAGS" \
    -Doptimize=" -Wall $CFLAGS " \
    -Dperl_static_inline='static __inline__' || {
      cat ./config.log
      return 42
    }
}

do_check() {
  export LD="$CC"
  TEST_JOBS="$XBPS_MAKEJOBS" make test
}

post_install() {
  find "$DESTDIR/usr/share" -type f -exec chmod 644 {} \;
  find "$DESTDIR/usr/lib" -type f -exec chmod 644 {} \;

  # make a symbolic link from perl to perl$version
  ln -sf perl "$DESTDIR/usr/bin/perl$version"

  # remove all pod files *except* those under
  # /usr/share/perl5/core_perl/pod/ (FS#16488)
  rm -f "$DESTDIR/usr/share/perl5/core_perl"/*.pod
  for d in "$DESTDIR/usr/share/perl5/core_perl"/*; do
    if [[ -d "$d" ]] && [[ "$(basename $d)" != "pod" ]]; then
      find "$d" -name *.pod -delete
    fi
  done
  find "$DESTDIR/usr/lib" -name *.pod -delete
  find "$DESTDIR" -name .packlist -delete

  # remove references to hardening -specs
  sed \
    -i \
    -e "s|-specs=.*hardened-ld||g" -e "s|-specs=.*hardened-cc1||g" \
    "$DESTDIR/usr/lib/perl5/core_perl/Config_heavy.pl"

  # HOTFIX
  #ln -sfr "$DESTDIR/usr/lib/perl5/core_perl/CORE/libperl.so.$version" "$DESTDIR/usr/lib/"
  #ln -sfr "$DESTDIR/usr/lib/perl5/core_perl/CORE/libperl.so.$version" "$DESTDIR/usr/lib/libperl.so"
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

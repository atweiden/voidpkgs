maintainer="nox"
pkgname="MoarVM"
version=2020.01.1
revision=1
short_desc="VM with adaptive optimization and JIT compilation, built for Rakudo"
makedepends+=" libatomic_ops-devel"
makedepends+=" libffi-devel"
# XXX: re-enable system libtommath for MoarVM-2020.02
# see: https://github.com/MoarVM/MoarVM/pull/1221
#makedepends+=" libtommath-devel"
makedepends+=" libuv-devel"
makedepends+=" libzstd-devel"
hostmakedepends+=" binutils"
hostmakedepends+=" perl"
hostmakedepends+=" pkgconf"
hostmakedepends+=" $(vopt_if clang clang)"
tags="raku"
homepage="https://moarvm.org"
license="Artistic-2.0"
changelog="https://github.com/MoarVM/MoarVM/raw/master/docs/ChangeLog"
distfiles="https://moarvm.org/releases/$pkgname-$version.tar.gz"
checksum="dcb61e44a098e8375c385eb9d52bd6394255a388697b2f6a52d88e6cf4a53587"
build_style="configure"
configure_script="perl Configure.pl"
configure_args+=" --has-libatomic_ops"
configure_args+=" --has-libffi"
# XXX: re-enable system libtommath for MoarVM-2020.02
#configure_args+=" --has-libtommath"
configure_args+=" --has-libuv"
configure_args+=" --optimize"
configure_args+=" --pkgconfig=/usr/bin/pkgconf"
configure_args+=" --prefix=/usr"
configure_args+=" --toolchain=gnu"
if [[ -n "$CROSS_BUILD" ]]; then
  configure_args+=" --build=$XBPS_CROSS_TRIPLET"
  configure_args+=" --host=$XBPS_CROSS_TRIPLET"
  export PKG_CONFIG_PATH="$XBPS_CROSS_BASE/usr/lib/pkgconfig:$XBPS_CROSS_BASE/usr/share/pkgconfig"
fi
if [[ -n "$(vopt_if clang clang)" ]]; then
  configure_args+=" --compiler=clang"
  nopie="yes"
fi
build_options="clang"
desc_option_clang="Use clang instead of gcc to compile MoarVM"
shlib_provides="libmoar.so"

post_install() {
  vlicense Artistic2.txt
  vlicense CREDITS
  vlicense LICENSE
  vdoc README.markdown
  vcopy docs "usr/share/doc/$pkgname/design"
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

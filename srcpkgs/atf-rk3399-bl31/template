maintainer="nox"
pkgname="atf-rk3399-bl31"
version=2.6
revision=1
short_desc="ARM Trusted Firmware for Rockchip rk3399 boards (ARMv8, bl31 option)"
archs="aarch64*"
hostmakedepends="cross-arm-none-eabi"
homepage="https://developer.trustedfirmware.org/dashboard/view/6/"
license="BSD-3-Clause"
distfiles="https://git.trustedfirmware.org/TF-A/trusted-firmware-a.git/snapshot/trusted-firmware-a-$version.tar.gz"
checksum="4e59f02ccb042d5d18c89c849701b96e6cf4b788709564405354b5d313d173f7"
wrksrc="trusted-firmware-a-$version"
nostrip="yes"

post_patch() {
  # adjust the baud rate to match uboot and the kernel for the pbp
  vsed \
    -i \
    -e 's/\(RK3399_BAUDRATE\s*\)115200/\11500000/' \
    plat/rockchip/rk3399/rk3399_def.h
}

do_build() {
  unset CFLAGS
  unset CPPFLAGS
  unset CXXFLAGS
  unset LDFLAGS
  if [[ -n "$CROSS_BUILD" ]]; then
    export CROSS_COMPILE="$XBPS_CROSS_TRIPLET-"
  fi
  make "$makejobs" PLAT="rk3399" bl31
}

do_install() {
  vinstall build/rk3399/release/bl31/bl31.elf 0755 usr/lib/trusted-firmware-a/rk3399
  vlicense docs/license.rst
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

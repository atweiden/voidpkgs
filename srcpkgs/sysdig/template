maintainer="nox"
pkgname="sysdig"
version=0.27.0
revision=3
short_desc="Open source system-level exploration and troubleshooting tool"
archs+=" i686"
archs+=" ppc64le"
archs+=" x86_64"
depends="dkms"
makedepends+=" LuaJIT-devel"
makedepends+=" c-ares-devel"
makedepends+=" elfutils-devel"
makedepends+=" grpc-devel"
makedepends+=" jsoncpp-devel"
makedepends+=" libcurl-devel"
makedepends+=" libprotoc-devel"
makedepends+=" libressl-devel"
makedepends+=" ncurses-devel"
makedepends+=" protobuf-devel"
makedepends+=" tbb-devel"
makedepends+=" zlib-devel"
hostmakedepends+=" pkg-config"
hostmakedepends+=" protobuf"
hostmakedepends+=" wget"
homepage="http://www.sysdig.org/"
license="Apache-2.0, MIT, GPL-2.0-only"
changelog="https://github.com/draios/sysdig/releases"
distfiles="https://github.com/draios/sysdig/archive/$version.tar.gz>$pkgname-$version.tar.gz"
checksum="a67f97b2620e3d9c5d48d07932604c938a5a6d3b625d7a23bfb2eb9802024b52"
build_style="cmake"
configure_args+=" -DBUILD_DRIVER=OFF"
configure_args+=" -DCREATE_TEST_TARGETS=OFF"
configure_args+=" -DLUA_INCLUDE_DIR=$XBPS_CROSS_BASE/usr/include/luajit-2.1"
configure_args+=" -DLUA_LIBRARY=libluajit-5.1.so"
configure_args+=" -DSYSDIG_VERSION=$version"
configure_args+=" -DUSE_BUNDLED_B64=ON"
configure_args+=" -DUSE_BUNDLED_DEPS=OFF"
configure_args+=" -DUSE_BUNDLED_JQ=ON"
nocross="yes"
disable_parallel_build="yes"
dkms_modules="sysdig $version"

# avoid excessive warnings spam to the log
CXXFLAGS="-Wno-deprecated-declarations"

post_extract() {
  sed \
    -i \
    -e 's,"${DIR_ETC}/bash_completion.d",share/bash-completion/completions,g' \
    scripts/CMakeLists.txt
  sed \
    -i \
    -e '1i#include <sys/select.h>' \
    userspace/libsinsp/mesos_collector.h
  sed \
    -i \
    -e '1i#include <sys/sysmacros.h>' \
    userspace/libscap/scap_fds.c
  sed \
    -i \
    -e '1iset(CMAKE_EXE_LINKER_FLAGS "-ltbb -lcurl")' \
    CMakeLists.txt
}

post_install() {
  rm -rf "$DESTDIR/usr/share/zsh/vendor-completions"
  vlicense COPYING
  vlicense NOTICES
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

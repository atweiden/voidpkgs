maintainer="nox"
pkgname="sysdig"
version=0.31.5
revision=1
_falcover=0.11.0
short_desc="Open source system-level exploration and troubleshooting tool"
depends="dkms"
makedepends+=" LuaJIT-devel"
makedepends+=" c-ares-devel"
makedepends+=" elfutils-devel"
makedepends+=" grpc-devel"
makedepends+=" json-c++"
makedepends+=" libcurl-devel"
makedepends+=" libprotoc-devel"
makedepends+=" ncurses-devel"
makedepends+=" openssl-devel"
makedepends+=" protobuf-devel"
makedepends+=" tbb-devel"
makedepends+=" yaml-cpp-devel"
makedepends+=" zlib-devel"
hostmakedepends+=" pkg-config"
hostmakedepends+=" protobuf"
hostmakedepends+=" wget"
homepage="http://www.sysdig.org/"
license="Apache-2.0, MIT, GPL-2.0-only"
changelog="https://github.com/draios/sysdig/releases"
distfiles+=" https://github.com/draios/sysdig/archive/$version.tar.gz>$pkgname-$version.tar.gz"
distfiles+=" https://github.com/falcosecurity/libs/archive/$_falcover.tar.gz"
checksum+=" 9af98cae7c38273f7429ba0df628c9745bd92c949f444e180b9dd800af14c6dd"
checksum+=" 90414d00591986e94f2c49e7d65eef5c2dedee266354dd3db8234bb3b06c86fa"
build_wrksrc="$pkgname-$version"
patch_args="-Np1 --directory=$build_wrksrc"
build_style="cmake"
configure_args+=" -DBUILD_DRIVER=OFF"
configure_args+=" -DBUILD_LIBSCAP_EXAMPLES=OFF"
configure_args+=" -DCMAKE_CXX_EXTENSIONS=OFF"
configure_args+=" -DCMAKE_CXX_STANDARD=17"
configure_args+=" -DCREATE_TEST_TARGETS=OFF"
configure_args+=" -DDRIVER_VERSION=$_falcover"
configure_args+=" -DLUA_INCLUDE_DIR=$XBPS_CROSS_BASE/usr/include/luajit-2.1"
configure_args+=" -DLUA_LIBRARY=/usr/lib/libluajit-5.1.so"
configure_args+=" -DSYSDIG_VERSION=$version"
configure_args+=" -DUSE_BUNDLED_B64=ON"
configure_args+=" -DUSE_BUNDLED_DEPS=OFF"
configure_args+=" -DUSE_BUNDLED_JQ=ON"
configure_args+=" -DUSE_BUNDLED_TBB=OFF"
nocross="yes"
dkms_modules="scap $_falcover"

case "$XBPS_TARGET_MACHINE" in
  i686*)
    broken="/syscall_table.c:567:10: error: '__NR_rt_tgsigqueueinfo'"
    ;;
  *-musl)
    configure_args+=" -DMUSL_OPTIMIZED_BUILD=On"
    ;;
esac

# avoid excessive warnings spam to the log
CXXFLAGS="-Wno-deprecated-declarations"

post_patch() {
  patch -d "$wrksrc/libs-$_falcover" -Np1 < "$FILESDIR/libsinsp-zstd.patch"
  patch -d "$wrksrc/libs-$_falcover" -Np1 < "$FILESDIR/libsinsp-absl-protobuf.patch"
  vsed \
    -i \
    -e 's,"${DIR_ETC}/bash_completion.d",share/bash-completion/completions,g' \
    scripts/CMakeLists.txt
}

post_install() {
  rm -rf "$DESTDIR/usr/share/zsh/vendor-completions"
  vlicense COPYING
  vlicense NOTICES
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

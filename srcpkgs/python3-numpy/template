maintainer="nox"
pkgname="python3-numpy"
version=1.26.0
revision=1
short_desc="Fast and sophisticated array facility to Python3"
depends="python3"
makedepends+=" python3-devel"
makedepends+=" $(vopt_if openblas 'openblas-devel' 'lapack-devel cblas-devel')"
checkdepends+=" meson"
checkdepends+=" python3-hypothesis"
checkdepends+=" python3-pytest-xdist"
checkdepends+=" python3-pytz"
hostmakedepends+=" gcc-fortran"
hostmakedepends+=" python3-Cython"
hostmakedepends+=" python3-setuptools"
homepage="https://www.numpy.org/"
license="BSD-3-Clause"
changelog="https://numpy.org/doc/stable/release.html"
distfiles="$PYPI_SITE/n/numpy/numpy-$version.tar.gz"
checksum="f93fc78fe8bf15afe2b8d6b6499f1c73953169fad1e9a8dd086cdff3190e7fdf"
build_style="python3-module"
build_options="openblas"
alternatives="numpy:f2py:/usr/bin/f2py3"

case "$XBPS_TARGET_MACHINE" in
  x86_64*|i686*|aarch64*|armv[67]*|ppc64*)
    # prefer accelerated routines where available
    build_options_default="openblas"
    ;;
  *)
    ;;
esac

if [[ -n "$build_option_openblas" ]]; then
  case "$XBPS_TARGET_MACHINE" in
    ppc64*)
      ;;
    ppc*)
      broken="segfaults"
      ;;
  esac
fi

# SVML AVX-512 functions have very limited support; disable for now
export NPY_DISABLE_SVML=1

post_patch() {
  case "$XBPS_TARGET_MACHINE" in
    armv5tel-musl)
      cp "$FILESDIR/fenv-constants.h" numpy/core/src/npymath/
      patch -Np0 -i "$FILESDIR/fenv-constants.patch"
      ;;
  esac

  if [[ "$XBPS_TARGET_LIBC" == "musl" ]]; then
    vsed \
      -i \
      -e 's|"backtrace",||' \
      numpy/core/setup_common.py
  fi
}

pre_build() {
  # build numpy in parallel
  make_build_args+=" $makejobs"

  # find the right linear algebra subroutines on the target arch
  : > site.cfg
  for _blaslib in $(vopt_if openblas 'openblas' 'lapack blas'); do
    cat >> site.cfg <<-EOF
[$_blaslib]
libraries = $_blaslib
include_dirs = $XBPS_CROSS_BASE/usr/include
library_dirs = $XBPS_CROSS_BASE/usr/lib
runtime_library_dirs = $XBPS_CROSS_BASE/usr/lib
EOF
  done
}

do_check() {
  local _skip
  local testjobs

  testjobs="-n $XBPS_MAKEJOBS"

  case $XBPS_TARGET_MACHINE in
    # this triggers a known bug in musl libm, fixed in: https://git.musl-libc.org/cgit/musl/commit/?id=aa2d23e57c9c95f0ffeb80cb035e5a5be52d8ef0
    *-musl)
      _skip+="or(test_against_cmath)"
      ;;
  esac

  if [[ ${XBPS_TARGET_MACHINE%-musl} == "i686" ]]; then
    # see: https://github.com/numpy/numpy/issues/18388
    _skip+="or(test_float_remainder_overflow)"
    _skip+="or(test_identityless_reduction_huge_array)"
    _skip+="or((TestKind)and(test_int))"
    # these 3 fail in ci but not locally
    _skip+="or(test_einsum_sums_int8)"
    _skip+="or(test_einsum_sums_uint8)"
    _skip+="or(test_einsum_sums_int16)"
  fi

  echo python3 runtests.py -- $testjobs ${_skip+-k "not(${_skip#or})"}
  python3 runtests.py -- $testjobs ${_skip+-k "not(${_skip#or})"}
}

post_install() {
  rm "$DESTDIR/usr/bin/f2py"
  rm "$DESTDIR/$py3_sitelib/numpy/LICENSE.txt"
  vlicense LICENSE.txt LICENSE
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

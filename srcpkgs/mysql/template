maintainer="nox"
pkgname="mysql"
version=5.6.43
revision=3
depends="mysql-client"
makedepends+=" libressl-devel"
makedepends+=" readline-devel"
makedepends+=" zlib-devel"
hostmakedepends+=" bison"
hostmakedepends+=" ncurses-devel"
hostmakedepends+=" perl"
short_desc="World's most popular open source database"
homepage="https://www.mysql.com/products/community/"
license="GPL-2.0-only"
distfiles="http://dev.mysql.com/get/Downloads/MySQL-${version%.*}/mysql-$version.tar.gz"
checksum="1c95800bf0e1b7a19a37d37fbc5023af85c6bc0b41532433b3a886263a1673ef"
conf_files="/etc/mysql/my.cnf"
build_style="cmake"
configure_args+=" -DDEFAULT_CHARSET=utf8"
configure_args+=" -DDEFAULT_COLLATION=utf8_general_ci"
configure_args+=" -DENABLED_LOCAL_INFILE=ON"
configure_args+=" -DHAVE_LLVM_LIBCPP_EXITCODE=0"
configure_args+=" -DINSTALL_DOCDIR=share/mysql/docs"
configure_args+=" -DINSTALL_DOCREADMEDIR=share/mysql"
configure_args+=" -DINSTALL_INCLUDEDIR=include/mysql"
configure_args+=" -DINSTALL_INFODIR=share/mysql/docs"
configure_args+=" -DINSTALL_MANDIR=share/man"
configure_args+=" -DINSTALL_MYSQLSHAREDIR=share/mysql"
configure_args+=" -DINSTALL_PLUGINDIR=lib/mysql/plugin"
configure_args+=" -DINSTALL_SCRIPTDIR=bin"
configure_args+=" -DINSTALL_SHAREDIR=share/mysql"
configure_args+=" -DINSTALL_SUPPORTFILESDIR=share/mysql"
configure_args+=" -DMYSQL_DATADIR=/var/lib/mysql"
configure_args+=" -DMYSQL_UNIX_ADDR=/run/mysqld/mysqld.sock"
configure_args+=" -DSTACK_DIRECTION=1"
configure_args+=" -DSYSCONFDIR=/etc/mysql"
configure_args+=" -DWITHOUT_ARCHIVE_STORAGE_ENGINE=1"
configure_args+=" -DWITHOUT_BLACKHOLE_STORAGE_ENGINE=1"
configure_args+=" -DWITHOUT_EXAMPLE_STORAGE_ENGINE=1"
configure_args+=" -DWITHOUT_FEDERATED_STORAGE_ENGINE=1"
configure_args+=" -DWITH_EMBEDDED_SERVER=ON"
configure_args+=" -DWITH_EXTRA_CHARSETS=complex"
configure_args+=" -DWITH_INNOBASE_STORAGE_ENGINE=1"
configure_args+=" -DWITH_LIBWRAP=OFF"
configure_args+=" -DWITH_PARTITION_STORAGE_ENGINE=1"
configure_args+=" -DWITH_SSL=system"
configure_args+=" -DWITH_ZLIB=system"
if [[ -n "$CROSS_BUILD" ]]; then
  configure_args+=" -DHAVE_LLVM_LIBCPP_EXITCODE=1"
  configure_args+=" -DHAVE_LLVM_LIBCPP_EXITCODE__TRYRUN_OUTPUT=0"
fi
system_accounts="mysql"
mysql_homedir="/var/lib/mysql"
lib32disabled="yes"

CFLAGS="-D__STDC_ISO_10646__"

pre_configure() {
  # libressl major detection
  sed \
    -i \
    -e '/OPENSSL_MAJOR_VERSION/s/1/2/' \
    cmake/ssl.cmake
  sed \
    -i \
    -e 's/sys\/poll\.h/poll.h/' \
    include/my_net.h

  # we need some host binaries before starting cross compilation
  if [[ -n "$CROSS_BUILD" ]]; then
    AR= \
    AS= \
    CC= \
    CFLAGS= \
    CPP= \
    CXX= \
    CXXFLAGS= \
    LD= \
    LDFLAGS= \
    RANLIB= \
      cmake .
    make \
      comp_err \
      comp_sql \
      gen_lex_hash \
      gen_lex_token
    mkdir -p bin.host
    cp extra/comp_err bin.host
    cp scripts/comp_sql bin.host
    cp sql/gen_lex_hash bin.host
    cp sql/gen_lex_token bin.host
    make clean
    rm CMakeCache.txt
  fi
}

pre_build() {
  if [[ -n "$CROSS_BUILD" ]]; then
    cp bin.host/comp_err "$wrksrc/extra"
    cp bin.host/comp_sql "$wrksrc/scripts"
    cp bin.host/gen_lex_hash "$wrksrc/sql"
    cp bin.host/gen_lex_token "$wrksrc/sql"
    export PATH="$PATH:$wrksrc/extra:$wrksrc/scripts:$wrksrc/sql"
  fi
}

post_install() {
  # remove unneeded stuff
  rm -rf "$DESTDIR/usr"/{sql-bench,mysql-test,data}
  rm -f "$DESTDIR/usr/share/man/man1/mysql-test-run.pl.1"
  # configuration file
  vinstall "$FILESDIR/my.cnf" 640 etc/mysql
  vsv mysqld
}

libmysqlclient_package() {
  short_desc+=" - client library"
  pkg_install() {
    vmove "usr/lib/libmysqlclient*.so.*"
  }
}
libmysqlclient-devel_package() {
  depends="libmysqlclient>=${version}_$revision"
  short_desc+=" - development files"
  pkg_install() {
    vmove usr/bin/mysql_config
    vmove usr/share/man/man1/mysql_config.1
    vmove usr/include
    vmove "usr/lib/*.a"
    vmove "usr/lib/*.so"
  }
}
mysql-client_package() {
  depends="perl"
  short_desc+=" - database client binaries"
  pkg_install() {
    for f in innochecksum \
             innotop \
             myisam_ftdump \
             mysql \
             mysql_client_test \
             mysql_client_test_embedded \
             mysql_find_rows \
             mysql_fix_extensions \
             mysql_upgrade \
             mysql_waitpid \
             mysqlaccess \
             mysql_zap \
             mysqladmin \
             mysqlanalyze \
             mysqlbinlog \
             mysqlbug \
             mysqlcheck \
             mysqldump \
             mysqldumpslow \
             mysqlhotcopy \
             mysqlimport \
             mysqlmanager \
             mysqloptimize \
             mysqlrepair \
             mysqlreport \
             mysqlshow \
             mysqlslap \
             mysqltest \
             mysqltest_embedded; do
      if [[ -f "$DESTDIR/usr/bin/$f" ]]; then
        vmove "usr/bin/$f"
      elif [[ -f "$DESTDIR/usr/sbin/$f" ]]; then
        vmove "usr/sbin/$f"
      fi
      if [[ -f "$DESTDIR/usr/share/man/man1/$f.1" ]]; then
        vmove "usr/share/man/man1/$f.1"
      elif [[ -f "$DESTDIR/usr/share/man/man8/$f.8" ]]; then
        vmove "usr/share/man/man8/$f.8"
      fi
    done
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

maintainer="nox"
pkgname="schilytools"
version=2023.04.19
revision=1
short_desc="Schily's portable tools"
depends+=" sccs"
depends+=" sdd"
depends+=" sfind"
depends+=" smake"
depends+=" star"
depends+=" ved"
makedepends+=" acl-devel"
makedepends+=" attr-devel"
makedepends+=" e2fsprogs-devel"
makedepends+=" m4"
homepage="https://codeberg.org/schilytools/schilytools"
license="CDDL-1.0"
distfiles="https://codeberg.org/schilytools/schilytools/archive/${version//./-}.tar.gz>$pkgname-$version.tar.gz"
checksum="a4270cdcca5dd69c0114079277b06e5efad260b0a099c9c09d31e16e99a23ff5"
build_style="meta"
# configure + re-builds with itself
nocross="yes"

do_build() {
  make \
    "$makejobs" \
    CC="$CC" \
    COPTX="$CFLAGS" \
    INS_BASE="/usr" \
    LDOPTX="$LDFLAGS"
  make \
    -C ved \
    "$makejobs" \
    CC="$CC" \
    COPTX="$CFLAGS" \
    INS_BASE="/usr" \
    LDOPTX="$LDFLAGS"
  make \
    -C sccs \
    clean
  make \
    -C sccs \
    CC="$CC" \
    COPTX="$CFLAGS" \
    INS_BASE="/usr/libexec/sccs" \
    LDOPTX="$LDFLAGS"
}

sccs_package() {
  short_desc+=" - sccs"
  pkg_install() {
    make \
      -C sccs \
      DESTDIR="$PKGDESTDIR" \
      INS_BASE="/usr/libexec/sccs" \
      install
    vmkdir usr/bin
    vmkdir usr/share
    rm -f "$PKGDESTDIR/usr/libexec/sccs/share/man"/man?/[!s]*
    mv "$PKGDESTDIR/usr/libexec/sccs/share/man" "$PKGDESTDIR/usr/share"
    rm -rf "$PKGDESTDIR/usr/libexec/sccs/bin"
    ln -sfr "$PKGDESTDIR/usr/libexec/sccs/ccs/bin/sccs" "$PKGDESTDIR/usr/bin/sccs"
    vlicense CDDL.Schily.txt
  }
}

sdd_package() {
  short_desc+=" - sdd"
  pkg_install() {
    make \
      -C sdd \
      DESTDIR="$PKGDESTDIR" \
      INS_BASE="/usr" \
      install
    vlicense CDDL.Schily.txt
  }
}

sfind_package() {
  short_desc+=" - sfind"
  pkg_install() {
    make \
      -C sfind \
      DESTDIR="$PKGDESTDIR" \
      INS_BASE="/usr" \
      install
    vlicense CDDL.Schily.txt
  }
}

smake_package() {
  short_desc+=" - smake"
  pkg_install() {
    make \
      -C smake \
      DESTDIR="$PKGDESTDIR" \
      INS_BASE="/usr" \
      install
    vlicense CDDL.Schily.txt
  }
}

star_package() {
  short_desc+=" - star"
  conf_files="/etc/default/star"
  alternatives+=" pax:pax:/usr/bin/spax"
  alternatives+=" pax:pax.1:/usr/share/man/man1/spax.1"
  pkg_install() {
    make \
      -C star \
      DESTDIR="$PKGDESTDIR" \
      INS_BASE="/usr" \
      SYMLINKS="suntar scpio spax" \
      install
    rm -f "$PKGDESTDIR/usr/share/man/man1/gnutar.1"
    rm -f "$PKGDESTDIR/usr/share/man/man1/ustar.1"
    rm -f "$PKGDESTDIR/usr/share/man/man1/gnutar.1"
    rm -f "$PKGDESTDIR/usr/share/man/man1"/*[!1]
    rm -f "$PKGDESTDIR/usr/share/man/man5"/*[!5]
    rm -rf "$PKGDESTDIR/usr/share/doc/"
    vlicense CDDL.Schily.txt
  }
}

ved_package() {
  short_desc+=" - ved"
  pkg_install() {
    make install -C ved DESTDIR="$PKGDESTDIR" INS_BASE="/usr"
    vlicense CDDL.Schily.txt
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

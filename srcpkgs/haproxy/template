maintainer="nox"
pkgname="haproxy"
version=2.1.3
revision=1
short_desc="Reliable, high performance TCP/HTTP load balancer"
makedepends+=" libressl-devel"
makedepends+=" lua-devel"
makedepends+=" pcre-devel"
homepage="https://www.haproxy.org"
license="GPL-2.0-or-later, LGPL-2.1-or-later"
distfiles="https://www.haproxy.org/download/${version%.*}/src/$pkgname-$version.tar.gz"
checksum="bb678e550374d0d9d9312885fb9d270b501dae9e3b336f0a4379c667dae00b59"
conf_files="/etc/haproxy/haproxy.cfg"
build_style="gnu-makefile"
make_build_args+=" TARGET=linux-glibc"
make_build_args+=" USE_GETADDRINFO=1"
make_build_args+=" USE_LIBCRYPT=1"
make_build_args+=" USE_LUA=1"
make_build_args+=" USE_OPENSSL=1"
make_build_args+=" USE_PCRE=1"
make_build_args+=" USE_PCRE_JIT=1"
make_build_args+=" USE_ZLIB=1"
make_install_args+=" DOCDIR=$DESTDIR/usr/share/doc/$pkgname"
make_install_args+=" SBINDIR=$DESTDIR/usr/bin"
system_accounts="haproxy"
haproxy_homedir="/var/lib/haproxy"
make_dirs="$haproxy_homedir 0750 haproxy haproxy"

case "$XBPS_TARGET_MACHINE" in
  *-musl)
    CFLAGS="-D__LINUX_NETFILTER_H"
    ;;
esac

if [[ -n "$XBPS_TARGET_NO_ATOMIC8" ]]; then
  makedepends+=" libatomic-devel"
  ADDLIB="-latomic"
fi


do_build() {
  make \
    "$makejobs" \
    ADDLIB="$ADDLIB" \
    CC="$CC" \
    CFLAGS="$CFLAGS" \
    EXTRA= \
    LDFLAGS="$LDFLAGS" \
    $make_build_args
}

post_install() {
  vinstall "$FILESDIR/haproxy.cfg" 644 "etc/haproxy"
  vsv haproxy
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

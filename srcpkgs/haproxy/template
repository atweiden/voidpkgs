maintainer="nox"
pkgname="haproxy"
version=2.6.13
revision=1
short_desc="Reliable, high performance TCP/HTTP load balancer"
makedepends+=" libatomic-devel"
makedepends+=" lua53-devel"
makedepends+=" openssl-devel"
makedepends+=" pcre2-devel"
checkdepends+=" curl"
checkdepends+=" varnish"
hostmakedepends="lua53-devel"
homepage="https://www.haproxy.org"
license="GPL-2.0-or-later, LGPL-2.1-or-later"
changelog="https://www.haproxy.org/download/${version%.*}/src/CHANGELOG"
distfiles="https://www.haproxy.org/download/${version%.*}/src/$pkgname-$version.tar.gz"
checksum="d69ff5233dbca657132ef280d111222ec1e33f5be1c1937d4e9ff516f63f5243"
conf_files="/etc/haproxy/haproxy.cfg"
build_style="gnu-makefile"
make_install_args+=" DOCDIR=$DESTDIR/usr/share/doc/$pkgname"
make_install_args+=" SBINDIR=$DESTDIR/usr/bin"
system_accounts="haproxy"
haproxy_homedir="/var/lib/haproxy"
make_dirs="$haproxy_homedir 0750 haproxy haproxy"

CFLAGS="-Wno-address-of-packed-member"

do_build() {
  local atomic
  local target

  if [[ -n "$XBPS_TARGET_NO_ATOMIC8" ]]; then
    atomic="-latomic"
  fi

  target="linux-$XBPS_TARGET_LIBC"

  make \
    ADDLIB="$atomic" \
    CC="$CC" \
    DEBUG_CFLAGS="$CFLAGS" \
    EXTRA= \
    LDFLAGS="$LDFLAGS" \
    TARGET=$target \
    USE_GETADDRINFO=1 \
    USE_LIBCRYPT=1 \
    USE_LUA=1 \
    USE_OPENSSL=1 \
    USE_PCRE2=1 \
    USE_PCRE2_JIT=1 \
    USE_PROMEX=1 \
    USE_ZLIB=1 \
    "$makejobs"
}

do_check() {
  export VTEST_PROGRAM="/usr/bin/varnishtest"
  make reg-tests \
    || : 4 test failed on musl
}

post_install() {
  vinstall "$FILESDIR/haproxy.cfg" 644 "etc/haproxy"
  vsv haproxy
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

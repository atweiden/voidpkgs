maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="chroot-distcc"
version=3.3.2
revision=2
short_desc="Distributed compilation for faster C/C++ builds - for xbps-src use"
makedepends="binutils-devel"
homepage="https://distcc.github.io"
license="GPL-2.0-or-later"
distfiles="https://github.com/distcc/distcc/releases/download/v$version/${pkgname#chroot-}-$version.tar.gz"
checksum="64894de2970c631801d29c9962553673ea7a1d150e6855d7e166d273fca5cdfc"
wrksrc="${pkgname#chroot-}"
bootstrap="yes"
build_style="gnu-configure"
configure_args+=" --disable-Werror"
configure_args+=" --disable-pump-mode"
configure_args+=" --with-included-popt"
configure_args+=" --without-avahi"
configure_args+=" --without-gnome"
configure_args+=" --without-gtk"
make_install_target="install-programs"
conflicts="distcc>=0"

pre_configure() {
  # copy files generated by package distcc running autogen.sh
  # manual update is required for every new version
  cp -p "$FILESDIR/configure" "$wrksrc"
  cp -p "$FILESDIR/Makefile.in" "$wrksrc"
  cp -p "$FILESDIR/config.h.in" "$wrksrc/src"
}

post_install() {
  local f
  local x
  # remove useless files
  rm -f "$DESTDIR/usr/bin/distccd"
  rm -rf "$DESTDIR/etc"
  rm -rf "$DESTDIR/usr/share"
  # gcc wrappers
  vmkdir usr/lib/distcc/bin
  for f in c++ \
           cc \
           g++ \
           gcc; do
    ln -sfr "$DESTDIR/usr/bin/distcc" "$DESTDIR/usr/lib/distcc/bin/$f"
  done
  # cross-gcc wrappers
  for x in arm-linux-gnueabi \
           arm-linux-gnueabihf \
           arm-linux-musleabihf \
           armv7l-linux-gnueabihf \
           armv7l-linux-musleabihf; do
    for f in c++ \
             cc \
             g++ \
             gcc; do
      ln -sfr "$DESTDIR/usr/bin/distcc" "$DESTDIR/usr/lib/distcc/bin/$x-$f"
    done
  done
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

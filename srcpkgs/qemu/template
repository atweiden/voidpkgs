maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="qemu"
version=4.2.0
revision=1
short_desc="Open Source Processor Emulator"
makedepends+=" bzip2-devel"
makedepends+=" gnutls-devel"
makedepends+=" libaio-devel"
makedepends+=" libcap-devel"
makedepends+=" libcap-ng-devel"
makedepends+=" libcurl-devel"
makedepends+=" libglib-devel"
makedepends+=" libjpeg-turbo-devel"
makedepends+=" libnfs-devel"
makedepends+=" libpng-devel"
makedepends+=" libsasl-devel"
makedepends+=" libseccomp-devel"
makedepends+=" libssh2-devel"
makedepends+=" libusb-devel"
makedepends+=" libuuid-devel"
makedepends+=" libxml2-devel"
makedepends+=" lzo-devel"
makedepends+=" ncurses-devel"
makedepends+=" nss-devel"
makedepends+=" pixman-devel"
makedepends+=" snappy-devel"
makedepends+=" usbredir-devel"
makedepends+=" vde2-devel"
makedepends+=" xfsprogs-devel"
makedepends+=" $(vopt_if numa libnuma-devel)"
makedepends+=" $(vopt_if smartcard libcacard-devel)"
makedepends+=" $(vopt_if spice spice-devel)"
hostmakedepends+=" automake"
hostmakedepends+=" flex"
hostmakedepends+=" libtool"
hostmakedepends+=" perl"
hostmakedepends+=" pkg-config"
hostmakedepends+=" python3"
hostmakedepends+=" python3-Sphinx"
homepage="https://www.qemu.org"
license="GPL-2.0-or-later, LGPL-2.1-or-later"
distfiles="https://wiki.qemu.org/download/$pkgname-$version.tar.bz2"
checksum="3cf4f3f73233a12211a045f07eef467fdc7bf3877568cd0c8a0cf36121da9fbd"
nostrip="yes"
build_options+=" numa"
build_options+=" smartcard"
build_options+=" spice"
build_options_default+=" numa"
build_options_default+=" smartcard"
desc_option_numa="Enable support for host NUMA"
desc_option_smartcard="Enable smartcard support"
desc_option_spice="Enable support for SPICE"

case "$XBPS_TARGET_MACHINE" in
  i686*|x86_64*|ppc64le*)
    build_options_default+=" spice"
    ;;
  aarch64-musl)
    CFLAGS+=" -D_LINUX_SYSINFO_H"
    ;;
esac

post_extract() {
  sed \
    -i \
    -e 's/__u64/unsigned long/' \
    linux-user/host/aarch64/hostdep.h
}

do_configure() {
  local args

  sed \
    -i \
    -e 's,-rpath /usr/local/lib,,g' \
    configure

  if [[ -n "$CROSS_BUILD" ]]; then
    args+=" --cross-prefix=$XBPS_CROSS_TRIPLET-"
    export LIBTOOL="libtool"
  fi
  unset CPP

  ./configure \
    $(vopt_enable smartcard) \
    $(vopt_enable spice) \
    $args \
    --audio-drv-list= \
    --datadir="/usr/lib" \
    --disable-bluez \
    --disable-cocoa \
    --disable-glusterfs \
    --disable-gtk \
    --disable-jemalloc \
    --disable-mpath \
    --disable-opengl \
    --disable-sdl \
    --disable-virglrenderer \
    --disable-vte \
    --disable-xen \
    --disable-xen-pci-passthrough \
    --enable-attr \
    --enable-bzip2 \
    --enable-cap-ng \
    --enable-curl \
    --enable-curses \
    --enable-docs \
    --enable-kvm \
    --enable-libssh2 \
    --enable-libusb \
    --enable-libxml2 \
    --enable-linux-aio \
    --enable-lzo \
    --enable-pie \
    --enable-seccomp \
    --enable-snappy \
    --enable-tools \
    --enable-tpm \
    --enable-usb-redir \
    --enable-vhost-crypto \
    --enable-vhost-net \
    --enable-virtfs \
    --enable-vnc \
    --enable-vnc-jpeg \
    --enable-vnc-png \
    --enable-vnc-sasl \
    --libexecdir="/usr/libexec" \
    --localstatedir="/var" \
    --prefix="/usr" \
    --sysconfdir="/etc"
}

do_build() {
  # remove our strip(1) wrapper... E2BIG
  rm -f "$XBPS_WRAPPERDIR/strip"
  make "$makejobs"
}

do_install() {
  # remove our strip(1) wrapper... E2BIG
  rm -f "$XBPS_WRAPPERDIR/strip"
  make DESTDIR="$DESTDIR" install
  # qemu-bridge-helper must be setuid for non privileged users
  chmod u+s "$DESTDIR/usr/libexec/qemu-bridge-helper"
  vsv qemu-ga
}

qemu-ga_package() {
  short_desc="QEMU Guest Agent"
  pkg_install() {
    vmove usr/bin/qemu-ga
    vmove etc/sv/qemu-ga
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

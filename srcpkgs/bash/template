maintainer="nox"
pkgname="bash"
version=5.1.016
revision=2
_bash_distver=${version%.*}
_bash_patchlevel=${version##*.}
_patchprefix="bash${_bash_distver/./}"
short_desc="GNU Bourne Again Shell"
makedepends="ncurses-devel"
checkdepends="perl"
hostmakedepends="bison"
homepage="https://www.gnu.org/software/bash/bash.html"
license="GPL-3.0-or-later"
distfiles="$GNU_SITE/bash/$pkgname-$_bash_distver.tar.gz"
checksum="b4a80f2ac66170b2913efbfb9f2594f1f76c7b1afd11f799e22035d63077fb4d"
_url="$GNU_SITE/bash/bash-$_bash_distver-patches"
for _p in $(seq -w 001 "$_bash_patchlevel"); do
  distfiles+=" $_url/$_patchprefix-$_p"
  skip_extraction+=" $_patchprefix-$_p"
done
checksum+=" cc012bc860406dcf42f64431bcd3d2fa7560c02915a601aba9cd597a39329baa"
checksum+=" ebb07b3dbadd98598f078125d0ae0d699295978a5cdaef6282fe19adef45b5fa"
checksum+=" 15ea6121a801e48e658ceee712ea9b88d4ded022046a6147550790caf04f5dbe"
checksum+=" 22f2cc262f056b22966281babf4b0a2f84cb7dd2223422e5dcd013c3dcbab6b1"
checksum+=" 9aaeb65664ef0d28c0067e47ba5652b518298b3b92d33327d84b98b28d873c86"
checksum+=" cccbb5e9e6763915d232d29c713007a62b06e65126e3dd2d1128a0dc5ef46da5"
checksum+=" 75e17d937de862615c6375def40a7574462210dce88cf741f660e2cc29473d14"
checksum+=" acfcb8c7e9f73457c0fb12324afb613785e0c9cef3315c9bbab4be702f40393a"
checksum+=" f22cf3c51a28f084a25aef28950e8777489072628f972b12643b4534a17ed2d1"
checksum+=" e45cda953ab4b4b4bde6dc34d0d8ca40d1cc502046eb28070c9ebcd47e33c3ee"
checksum+=" a2c8d7b2704eeceff7b1503b7ad9500ea1cb6e9393faebdb3acd2afdd7aeae2a"
checksum+=" 58191f164934200746f48459a05bca34d1aec1180b08ca2deeee3bb29622027b"
checksum+=" 10f189c8367c4a15c7392e7bf70d0ff6953f78c9b312ed7622303a779273ab98"
checksum+=" c7acb66df435d284304c16ca83a5265f9edd9368612095b01a733d45c77ed5ad"
checksum+=" 6a4ee0c81b437b96279a792c1efcec4ba56f009195a318083db6b53b096f83d0"
checksum+=" 1b37692ef1f6cc3dcec246773443276066e6b1379868f8c14e01f4dfd4df80f0"
checksum+=" 8899144f76a5db1fb41a89ed881c9f19add95728dd71db324f772ef225c5384f"
build_style="gnu-configure"
configure_args+=" --with-curses"
configure_args+=" --without-bash-malloc"
configure_args+=" --without-installed-readline"
make_build_args="TERMCAP_LIB=$XBPS_CROSS_BASE/usr/lib/libncursesw.a"
register_shell+=" /bin/bash"
register_shell+=" /usr/bin/bash"
make_dirs="/etc/bash/bashrc.d 755 root root"
conflicts="chroot-bash>=0"
alternatives+=" sh:sh:/usr/bin/bash"
alternatives+=" sh:sh.1:/usr/share/man/man1/bash.1"

CFLAGS="-DNON_INTERACTIVE_LOGIN_SHELLS -DSYS_BASHRC='\"/etc/bash/bashrc\"'"

post_patch() {
  cd "$wrksrc"
  for _p in $(seq -w 001 "$_bash_patchlevel"); do
    msg_normal " Applying patch $_patchprefix-$_p.\n"
    patch -sNp0 -i "$XBPS_SRCDISTDIR/bash-$version/$_patchprefix-$_p"
  done
}

do_check() {
  # when xbps-src is run from interactive shell, this tests receives
  # SIGTTIN, and suspends xbps-src
  sed \
    -i \
    -e '/read -t 2 a < \/dev\/tty/,/echo $a/ d' \
    tests/read2.sub
  sed \
    -i \
    -e '/timeout 1: ok/,+1 d' \
    -e '/read2.sub: line 36: read:/s/ 36:/ 27:/' \
    tests/read.right
  make tests
}

post_install() {
  rm -rf "$DESTDIR/usr/share/doc"
  ln -s bash "$DESTDIR/usr/bin/rbash"
  vinstall "$FILESDIR/bashrc" 644 etc/bash
  vinstall "$FILESDIR/bash.sh" 644 etc/profile.d
}

bash-devel_package() {
  short_desc+=" - development files"
  pkg_install() {
    vmove usr/include
    vmove usr/lib/bash
    vmove usr/lib/pkgconfig
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="crystal"
version=0.29.0
revision=1
_shardsversion=0.8.1
_bootstrapversion=0.29.0
_bootstraprevision=1
short_desc="Crystal Programming Language"
depends+=" gc-devel"
depends+=" gcc"
depends+=" gmp-devel"
depends+=" libatomic_ops"
depends+=" libevent-devel"
depends+=" libressl-devel"
depends+=" libxml2-devel"
depends+=" libyaml-devel"
depends+=" llvm"
depends+=" pcre-devel"
depends+=" pkg-config"
makedepends+=" gc-devel"
makedepends+=" libatomic_ops"
makedepends+=" libevent-devel"
makedepends+=" libxml2-devel"
makedepends+=" libyaml-devel"
makedepends+=" pcre-devel"
checkdepends+=" gmp-devel"
checkdepends+=" libressl-devel"
checkdepends+=" libyaml-devel"
checkdepends+=" readline-devel"
hostmakedepends+=" git"
hostmakedepends+=" llvm"
homepage="https://crystal-lang.org/"
license="Apache-2.0"
distfiles+=" https://github.com/crystal-lang/crystal/archive/$version.tar.gz"
distfiles+=" https://github.com/crystal-lang/shards/archive/v$_shardsversion.tar.gz"
checksum+=" c2265b2a904ded282751f59a3bd0367072058eee1cf51ebe0af03a572f8e19b9"
checksum+=" 75c74ab6acf2d5c59f61a7efd3bbc3c4b1d65217f910340cb818ebf5233207a5"
build_options="binary_bootstrap"
build_options_default="binary_bootstrap"
desc_option_binary_bootstrap="Bootstrap using precompiled binaries"
nocross="FIXME: someone needs to sort out the llvm --cxxflags for cross building"
broken="llvm7"

_crystalflags+=" --no-debug"
_crystalflags+=" --progress"
_crystalflags+=" --release"

if [[ -n "$build_option_binary_bootstrap" ]]; then
  case "$XBPS_MACHINE" in
    x86_64)
      distfiles+=" https://github.com/crystal-lang/crystal/releases/download/$_bootstrapversion/$pkgname-$_bootstrapversion-$_bootstraprevision-linux-x86_64.tar.gz"
      checksum+=" cad27db08542947e788e7c06fc00691c05ba678cedf20ecf9baa8cee741233f3"
      ;;
    i686)
      distfiles+=" https://github.com/crystal-lang/crystal/releases/download/$_bootstrapversion/$pkgname-$_bootstrapversion-$_bootstraprevision-linux-i686.tar.gz"
      checksum+=" 0296df4824cadddadba0c052bd1fdc4ad1bdfe5758c688e7b1764ca163bca0db"
      ;;
    *)
      broken="cannot be built on $XBPS_MACHINE"
      ;;
  esac
else
  hostmakedepends+=" crystal"
fi

do_extract() {
  mkdir -p "$wrksrc"/{shards,$(vopt_if binary_bootstrap bootstrap)}
  tar xfz "$XBPS_SRCDISTDIR/$pkgname-$version/$version.tar.gz" \
    --strip-components=1 \
    -C "$wrksrc"
  tar xfz "$XBPS_SRCDISTDIR/$pkgname-$version/v$_shardsversion.tar.gz" \
    --strip-components=1 \
    -C "$wrksrc/shards"
  if [[ -n "$build_option_binary_bootstrap" ]]; then
    tar xfz "$XBPS_SRCDISTDIR/$pkgname-$version/$pkgname-$_bootstrapversion-$_bootstraprevision-linux-$XBPS_TARGET_MACHINE.tar.gz" \
      --strip-components=1 \
      -C "$wrksrc/bootstrap"
  fi
}

do_build() {
  if [[ -z $disable_parallel_build ]] && [[ -n $XBPS_MAKEJOBS ]]; then
    _crystalflags+=" --threads ${makejobs:2:4}"
  fi
  make \
    "$makejobs" \
    $(vopt_if binary_bootstrap PATH="$wrksrc/bootstrap/bin:$PATH")
    CRYSTAL_CACHE_DIR="/tmp/crystal" \
    CRYSTAL_CONFIG_PATH="lib:/usr/lib/crystal" \
    CRYSTAL_CONFIG_VERSION="$version" \
    FLAGS="$_crystalflags" \
    release=1 \
  make \
    "$makejobs" \
    CRYSTAL_CACHE_DIR="/tmp/crystal" \
    docs

  cd shards
  "$wrksrc/bin/crystal" build $_crystalflags -o bin/shards src/shards.cr
}

do_check() {
  make \
    "$makejobs" \
    CRYSTAL_CACHE_DIR="/tmp/crystal" \
    CRYSTAL_CONFIG_VERSION="$version" \
    PATH=".build:$PATH" \
    spec

  cd shards
  make test CRYSTAL_BIN="$wrksrc/bin/crystal"
}

do_install() {
  vmkdir /usr/bin
  vmkdir /usr/lib/crystal
  vmkdir /usr/share/doc/crystal
  vmkdir /usr/share/doc/crystal/api
  vmkdir /usr/share/bash-completion/completions/crystal
  vmkdir /usr/share/zsh/site-functions/_crystal
  vmkdir /usr/share/licenses/shards

  vcopy etc/completion.bash /usr/share/bash-completion/completions/crystal
  vcopy etc/completion.zsh /usr/share/zsh/site-functions/_crystal
  vcopy samples /usr/share/doc/crystal
  vcopy "docs/*" /usr/share/doc/crystal/api
  vcopy "src/*" /usr/lib/crystal
  vbin .build/crystal crystal
  vlicense LICENSE
  vman man/crystal.1
  vbin shards/bin/shards
  cp shards/LICENSE "$DESTDIR/usr/share/licenses/shards"
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

maintainer="nox"
pkgname="nspr"
version=4.32
revision=1
short_desc="NetScape Portable Runtime"
makedepends="zlib-devel"
homepage="http://www.mozilla.org/projects/nspr/"
license="MPL-2.0"
distfiles="$MOZILLA_SITE/nspr/releases/v$version/src/$pkgname-$version.tar.gz"
checksum="bb6bf4f534b9559cf123dcdc6f9cd8167de950314a90a88b2a329c16836e7f6c"
build_wrksrc="nspr"
build_style="gnu-configure"
configure_args+=" --enable-debug"
configure_args+=" --enable-ipv6"
configure_args+=" --enable-optimize"
if [[ "$XBPS_TARGET_WORDSIZE" == 64 ]]; then
  configure_args+=" --enable-64bit"
fi

CFLAGS="-D_PR_POLL_AVAILABLE -D_PR_HAVE_OFF64_T -D_PR_INET6 -D_PR_HAVE_INET_NTOP -D_PR_HAVE_GETHOSTBYNAME2 -D_PR_HAVE_GETADDRINFO -D_PR_INET6_PROBE"

if [[ -n "$CROSS_BUILD" ]]; then
  # nspr misused host in place of build
  configure_args+=" --host=$XBPS_TRIPLET"
  configure_args+=" --target=$XBPS_CROSS_TRIPLET"
  export HOST_CC="$CC_FOR_BUILD"
  export HOST_CFLAGS="$CFLAGS_FOR_BUILD"
  export HOST_LDFLAGS="$LDFLAGS_FOR_BUILD"
fi

post_install() {
  sed \
    -i \
    -e "s|\(-specs=.*hardened-ld\)||g" \
    "$DESTDIR/usr/bin/nspr-config"
  ln -s nspr.pc "$DESTDIR/usr/lib/pkgconfig/mozilla-nspr.pc"
  rm -r "$DESTDIR/usr/bin"/{compile-et.pl,prerr.properties}
  rm -r "$DESTDIR/usr/include/nspr/md"
}

nspr-devel_package() {
  depends="nspr>=${version}_$revision"
  short_desc+=" - development files"
  pkg_install() {
    vmove usr/include
    vmove usr/bin
    vmove usr/lib/pkgconfig
    vmove usr/share/aclocal
    vmove "usr/lib/*.a"
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

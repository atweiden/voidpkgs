maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="libsasl"
version=2.1.26
revision=5
short_desc="Cyrus SASL - runtime shared libraries"
makedepends="db-devel"
hostmakedepends+=" automake"
hostmakedepends+=" libtool"
hostmakedepends+=" pkg-config"
homepage="http://cyrusimap.web.cmu.edu/"
license="BSD"
distfiles="ftp://ftp.cyrusimap.org/cyrus-sasl/${pkgname/lib/cyrus-}-$version.tar.gz"
checksum="8fbc5136512b59bb793657f36fadda6359cae3b08f01fd16b3d406f1345b7bc3"
wrksrc="${pkgname/lib/cyrus-}-$version"
patch_args="-Np1"
build_style="gnu-configure"
configure_args+=" --disable-krb4"
configure_args+=" --disable-otp"
configure_args+=" --disable-srp"
configure_args+=" --disable-srp-setpass"
configure_args+=" --enable-anon"
configure_args+=" --enable-auth-sasldb"
configure_args+=" --enable-cram"
configure_args+=" --enable-digest"
configure_args+=" --enable-gssapi"
configure_args+=" --enable-login"
configure_args+=" --enable-ntlm"
configure_args+=" --enable-plain"
configure_args+=" --with-configdir=/etc/sasl2:/etc/sasl:/usr/lib/sasl2"
configure_args+=" --with-devrandom=/dev/random"

# seems to be cured with libtool>=2.4.6
#disable_parallel_build=yes

pre_configure() {
  # XXX
  if [[ -n "$CROSS_BUILD" ]]; then
    sed \
      -i \
      -e 's,AC_TRY_RUN,AC_TRY_LINK_FUNC,' \
      cmulocal/sasl2.m4
  fi

  # remove outdated files
  rm -f config/config.{guess,sub}
  rm -f config/lt{config,main.sh} config/libtool.m4

  # rename configure.in for fewer warnings
  mv configure.{in,ac}

  # avoid picking up the target LDFLAGS for makemd5
  sed \
    -i \
    -e "/^CFLAGS/a LDFLAGS =" \
    include/Makefile.am

  # rename configure.in for fewer warnings
  mv saslauthd/configure.{in,ac}

  # remove check for KRB4; otherwise we would need mt-krb4-devel
  rm -f config/kerberos_v4.m4

  # remove placeholder for KRB4 library
  find -name Makefile.am \
    -exec sed \
            -i \
            -e "s;= @SASL_KRB_LIB@;= ;" \
            "{}" \;

  autoreconf -I "$(pwd)/config" -I "$(pwd)/cmulocal" -i -f
}

post_install() {
  vlicense COPYING
  # we are only interested in libsasl
  rm -rf "$DESTDIR/usr"/{bin,sbin,share,lib/sasl2}
}

libsasl-devel_package() {
  depends="libsasl>=${version}_$revision"
  short_desc+=" - development files"
  pkg_install() {
    vmove usr/include
    vmove "usr/lib/*.so"
    vmove usr/lib/pkgconfig
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

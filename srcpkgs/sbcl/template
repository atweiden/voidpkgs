maintainer="nox"
pkgname="sbcl"
version=2.2.3
revision=1
short_desc="Steel Bank Common Lisp"
archs+=" aarch64"
archs+=" armv7l"
archs+=" i686"
archs+=" ppc64le*"
archs+=" x86_64*"
makedepends="zlib-devel"
hostmakedepends+=" iana-etc"
hostmakedepends+=" texinfo"
homepage="http://www.sbcl.org/"
license="custom:BSD+public_domain"
changelog="http://www.sbcl.org/news.html"
distfiles="$SOURCEFORGE_SITE/sbcl/$pkgname-$version-source.tar.bz2"
checksum="de7f49e1f7750fd2cd89111ef70641cc5471355f621b737392ac68aa95f37f9f"
conf_files="/etc/sbclrc"
nocross="yes"
nopie="yes"

_bootstrap_lisp="bash ../sbcl-*-linux/run-sbcl.sh --no-sysinit --no-userinit --disable-debugger"

case "$XBPS_TARGET_MACHINE" in
  x86_64)
    distfiles+=" $SOURCEFORGE_SITE/sbcl/$pkgname-$version-x86-64-linux-binary.tar.bz2"
    checksum+=" 8745f9358b686819209e188a93fb8cf5b4227a3f623af20504a68d129a314256"
    ;;
  i686)
    distfiles+=" $SOURCEFORGE_SITE/sbcl/$pkgname-1.4.3-x86-linux-binary.tar.bz2"
    checksum+=" 6bed7e31bb28e841da7bfc48c75adb8bef19e5e07d1d6f0fc7487f022c32f92c"
    ;;
  arm*)
    distfiles+=" $SOURCEFORGE_SITE/sbcl/$pkgname-1.2.14-armhf-linux-binary.tar.bz2"
    checksum+=" a5fbf1d596a909a7719bc4a958f00e8537bf399fa051f83736baee950b21e56a"
    ;;
  aarch64)
    distfiles+=" $SOURCEFORGE_SITE/sbcl/$pkgname-1.3.9-arm64-linux-binary.tar.bz2"
    checksum+=" 14c8fc0f3a03416b5d23763156e2bb28b690fb665af1e6f6112201fd0ddcd512"
    ;;
  ppc*|*-musl)
    # ecl bootstrap is broken since 2.2.0:
    # https://build.voidlinux.org/builders/x86_64-musl_builder/builds/39694/steps/shell_3/logs/stdio
    makedepends+=" clisp"
    _bootstrap_lisp="clisp"
    ;;
esac

do_build() {
  printf '"%s.void.%s"\n' "$version" "$revision" > version.lisp-expr
  export CFLAGS+=" -D_GNU_SOURCE -fno-omit-frame-pointer -DSBCL_HOME=/usr/lib/sbcl"
  export LINKFLAGS="$LDFLAGS"
  bash make.sh \
    "$_bootstrap_lisp" \
    --prefix="/usr" \
    --with-sb-core-compression \
    --without-sb-test
  make -C ./doc/manual info
}

do_install() {
  SBCL_HOME="" INSTALL_ROOT="$DESTDIR/usr" sh install.sh
  vlicense COPYING LICENSE
  vconf "$FILESDIR/sbclrc"
}

sbcl-source_package() {
  depends="$sourcepkg>=${version}_$revision"
  short_desc+=" - source files"
  pkg_install() {
    cd "$wrksrc"
    ./clean.sh
    vmkdir usr/lib/sbcl
    vcopy src usr/lib/sbcl
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

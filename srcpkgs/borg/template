maintainer="nox"
pkgname="borg"
version=1.2.1
revision=1
short_desc="Deduplicating backup program with compression and encryption"
depends+=" python3-argon2"
depends+=" python3-llfuse"
depends+=" python3-msgpack"
depends+=" python3-packaging"
makedepends+=" acl-devel"
makedepends+=" liblz4-devel"
makedepends+=" libzstd-devel"
makedepends+=" openssl-devel"
makedepends+=" python3-devel"
# llfuse is purposefully not included in checkdepends since the tests
# using it don't work in chroot
checkdepends+=" ${depends/python3-llfuse/}"
checkdepends+=" python3-pytest"
hostmakedepends+=" python3-dateutil"
hostmakedepends+=" python3-pkgconfig"
hostmakedepends+=" python3-setuptools"
homepage="https://borgbackup.github.io/"
license="BSD-3-Clause"
changelog="https://borgbackup.readthedocs.io/en/stable/changes.html#changelog"
distfiles="$PYPI_SITE/b/borgbackup/borgbackup-$version.tar.gz"
checksum="9f9ce2d1923cb33a147ee6d08177d860974567721b1142fca67914a02e64c633"
wrksrc="borgbackup-$version"
build_style="python3-module"
make_check_args="-k not((benchmark)or(test_readonly_check)or(test_readonly_diff)or(test_readonly_export_tar)or(test_readonly_extract)or(test_readonly_info)or(test_readonly_list))"
make_check_target="build/lib.*/borg/testsuite"

export BORG_LIBLZ4_PREFIX="$XBPS_CROSS_BASE/usr"
export BORG_LIBZSTD_PREFIX="$XBPS_CROSS_BASE/usr"
export BORG_OPENSSL_PREFIX="$XBPS_CROSS_BASE/usr"

pre_build() {
  vsed \
    -i \
    -e '/setup_requires=/d' \
    -e '/use_scm_version=/,+2d' \
    -e "/name=/ a\
        version='$version'," \
    setup.py
}

post_install() {
  vlicense LICENSE

  for f in docs/man/*.1 ; do
    vman "$f"
  done

  cd scripts/shell_completions
  vcompletion "bash/$pkgname" bash
  vcompletion "fish/$pkgname.fish" fish
  vcompletion "zsh/_$pkgname" zsh
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

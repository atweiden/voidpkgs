maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="tbb"
version=2019.U6
revision=1
# version rewrite: 2017_U7 (upstream) => 2017.7 (xbps)
_ver=${version/./_}
short_desc="Intel Threading Building Blocks"
archs+=" aarch64*"
archs+=" armv7l*"
archs+=" i686*"
archs+=" ppc64"
archs+=" ppc64le*"
archs+=" x86_64*"
hostmakedepends="cmake"
homepage="https://www.threadingbuildingblocks.org"
license="Apache-2.0"
distfiles="https://github.com/intel/tbb/archive/$_ver.tar.gz>$pkgname-$version.tar.gz"
checksum="2ba197b3964fce8a84429dd15b75eba7434cb89afc54f86d5ee6f726fdbe97fd"
wrksrc="$pkgname-$_ver"
build_style="gnu-makefile"

case "$XBPS_TARGET_MACHINE" in
  armv7l*)
    make_build_args="arch=armv7"
    ;;
  aarch64*)
    make_build_args="arch=arm64"
    ;;
esac

post_extract() {
  sed \
    -i \
    -e 's|CPLUS = g..|CPLUS = $(CXX)|g' \
    -e 's|CONLY = gcc|CONLY = $(CC)|g' \
    build/linux.gcc.inc

  # alternative might be:
  # https://git.alpinelinux.org/cgit/aports/tree/testing/libtbb/glibc-struct-mallinfo.patch
  case "$XBPS_TARGET_MACHINE" in
    *-musl)
      sed \
        -i \
        -e "s@#define MALLOC_UNIXLIKE_OVERLOAD_ENABLED __linux__@@" \
        src/tbbmalloc/proxy.h
    ;;
  esac
}

do_install() {
  vmkdir usr/lib
  vcopy "build/linux_*/*.so*" usr/lib
  vmkdir usr/include/tbb
  vcopy "include/tbb/*" usr/include/tbb
  cmake \
    -DINSTALL_DIR="$DESTDIR/usr/lib/cmake/TBB" \
    -DSYSTEM_NAME="Linux" \
    -DLIB_REL_PATH="../.." \
    -DINC_REL_PATH="../../../include" \
    -P cmake/tbb_config_installer.cmake
}

tbb-devel_package() {
  depends="$sourcepkg>=${version}_$revision"
  short_desc+=" - development files"
  pkg_install() {
    vmove usr/include
    vmove "usr/lib/*.so"
    vmove usr/lib/cmake
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

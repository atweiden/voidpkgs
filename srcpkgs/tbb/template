maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="tbb"
version=2019.U3
revision=1
# version rewrite: 2017_U7 (upstream) => 2017.7 (xbps)
_ver=${version/./_}
short_desc="Intel Threading Building Blocks"
only_for_archs+=" aarch64"
only_for_archs+=" aarch64-musl"
only_for_archs+=" armv7l"
only_for_archs+=" armv7l-musl"
only_for_archs+=" i686"
only_for_archs+=" i686-musl"
only_for_archs+=" ppc64"
only_for_archs+=" ppc64le"
only_for_archs+=" ppc64le-musl"
only_for_archs+=" x86_64"
only_for_archs+=" x86_64-musl"
homepage="https://www.threadingbuildingblocks.org"
license="Apache-2.0"
distfiles="https://github.com/01org/tbb/archive/$_ver.tar.gz>$pkgname-$version.tar.gz"
checksum="b2244147bc8159cdd8f06a38afeb42f3237d3fc822555499d7ccfbd4b86f8ece"
wrksrc="$pkgname-$_ver"
build_style="gnu-makefile"

case "$XBPS_TARGET_MACHINE" in
  armv7l*)
    make_build_args="arch=armv7"
    ;;
  aarch64*)
    make_build_args="arch=arm64"
    ;;
esac

post_extract() {
  sed \
    -i \
    -e 's|CPLUS = g..|CPLUS = $(CXX)|g' \
    -e 's|CONLY = gcc|CONLY = $(CC)|g' \
    build/linux.gcc.inc

  # alternative might be:
  # https://git.alpinelinux.org/cgit/aports/tree/testing/libtbb/glibc-struct-mallinfo.patch
  case "$XBPS_TARGET_MACHINE" in
    *-musl)
      sed \
        -i \
        -e "s@#define MALLOC_UNIXLIKE_OVERLOAD_ENABLED __linux__@@" \
        src/tbbmalloc/proxy.h
    ;;
  esac
}

do_install() {
  vmkdir usr/lib
  vcopy "build/linux_*/*.so*" usr/lib
  vmkdir usr/include/tbb
  vcopy "include/tbb/*" usr/include/tbb
}

tbb-devel_package() {
  depends="$sourcepkg>=${version}_$revision"
  short_desc+=" - development files"
  pkg_install() {
    vmove usr/include
    vmove "usr/lib/*.so"
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="nodejs-lts"
version=8.11.3
revision=4
short_desc="Evented I/O for V8 javascript"
makedepends+=" python-devel"
makedepends+=" zlib-devel"
makedepends+=" $(vopt_if http_parser http-parser-devel)"
makedepends+=" $(vopt_if icu icu-devel)"
makedepends+=" $(vopt_if libuv libuv-devel)"
makedepends+=" $(vopt_if ssl libressl-devel)"
hostmakedepends+=" pkg-config"
hostmakedepends+=" python"
hostmakedepends+=" $(vopt_if icu icu)"
homepage="https://nodejs.org/"
license="MIT"
distfiles="$homepage/dist/v$version/node-v$version.tar.gz"
checksum="0d7e795c0579226c8b197353bbb9392cae802f4fefa4787a2c0e678beaf85cce"
wrksrc="node-v$version"
build_options+=" http_parser"
build_options+=" icu"
build_options+=" libuv"
build_options+=" ssl"
desc_option_libuv="Enable shared libuv"
desc_option_http_parser="Enable shared http-parser"
desc_option_icu="Enable shared icu"
build_options_default+=" http_parser"
build_options_default+=" icu"
build_options_default+=" libuv"
provides="nodejs-runtime-0_1"
conflicts="nodejs"
replaces="iojs>=0"

do_configure() {
  local _args
  export LD="$CXX"
  if [[ -n "$CROSS_BUILD" ]]; then
    case "$XBPS_TARGET_MACHINE" in
      arm*)
        _args+=" --dest-cpu=arm"
        _args+=" --without-snapshot"
        ;;
      aarch64*)
        _args+=" --dest-cpu=arm64"
        _args+=" --without-snapshot"
        ;;
      *)
        msg_error "$pkgver: cannot be cross compiled for $XBPS_TARGET_MACHINE\n"
        ;;
    esac
  fi
  ./configure \
    $_args \
    --prefix="/usr" \
    --shared-zlib \
    $(vopt_if http_parser --shared-http-parser) \
    $(vopt_if icu --with-intl=system-icu) \
    $(vopt_if libuv --shared-libuv) \
    $(vopt_if ssl --shared-openssl)
}

do_build() {
  if [[ -n "$CROSS_BUILD" ]]; then
    make LD="$CXX" LDFLAGS+="-ldl" "$makejobs" PORTABLE=1 V=1
  else
    make LD="$CXX" LDFLAGS+="-ldl" "$makejobs" V=1
  fi
}

do_install() {
  vlicense LICENSE
  make LD="$CXX" LDFLAGS+="-ldl" DESTDIR="$DESTDIR" install
  rm -r "$DESTDIR/usr/include"
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

maintainer="nox"
pkgname="github-cli"
version=2.28.0
revision=1
short_desc="GitHub CLI tool"
homepage="https://cli.github.com"
license="MIT"
changelog="https://github.com/cli/cli/releases"
distfiles="https://github.com/cli/cli/archive/v$version.tar.gz>$pkgname-$version.tar.gz"
checksum="cf3c0fb7f601d717d8b5177707a197c49fd426f5dc3c9aa52a932e96ba7166af"
build_style="go"
go_import_path="github.com/cli/cli/v2/cmd/gh"
go_build_tags+=" netgo"
go_build_tags+=" osusergo"
go_ldflags+=" -buildid="
go_ldflags+=" -X github.com/cli/cli/v2/internal/build.Version=v$version"
if [[ "$XBPS_TARGET_LIBC" == "musl" ]]; then
  go_ldflags+=" -extldflags=-static"
  go_ldflags+=" -linkmode=external"
fi
# shell completion generation requires qemu (see: upstream)
nocross="yes"

export GOFLAGS="-trimpath"

pre_build() {
  local _date

  if [[ -n "$SOURCE_DATE_EPOCH" ]]; then
    _date="$(date --utc --date "@$SOURCE_DATE_EPOCH" "+%Y-%m-%d")"
    go_ldflags+=" -X github.com/cli/cli/v2/internal/build.Date=$_date"
  fi
}

post_install() {
  vlicense LICENSE
  CGO_ENABLED=0 GOARCH="" go run script/build.go manpages
  vcopy share/man usr/share
  # build shell completions without cross-platform support (see: upstream)
  for shell in bash \
               fish \
               zsh; do
    "$DESTDIR/usr/bin/gh" completion -s "$shell" > "github-cli.$shell"
    vcompletion "github-cli.$shell" "$shell" gh
  done
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

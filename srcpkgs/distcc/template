maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="distcc"
version=3.2rc1
revision=15
short_desc="Distributed compilation for faster C/C++ builds"
makedepends+=" avahi-libs-devel"
makedepends+=" popt-devel"
makedepends+=" python-devel"
hostmakedepends="pkg-config"
homepage="https://distcc.github.io"
license="GPL-2"
distfiles="https://github.com/distcc/$pkgname/releases/download/v$version/$pkgname-$version.tar.bz2"
checksum="311671e844625d7fdb18dd3d096cd855751cfe8de13827682bcb7beff9133b30"
conf_files+=" /etc/distcc/clients.allow"
conf_files+=" /etc/distcc/hosts"
build_style="gnu-configure"
configure_args+=" --disable-Werror"
configure_args+=" --without-gnome"
configure_args+=" --without-gtk"
conflicts="chroot-distcc>=0"

post_install() {
  local f
  local x

  # remove useless files
  rm -f "$DESTDIR/etc/default/distcc"
  rm -f "$DESTDIR/etc/distcc/commands.allow.sh"
  rm -rf "$DESTDIR/usr/share/doc/distcc/example"

  vsv distccd

  # gcc wrappers
  vmkdir usr/lib/distcc/bin
  for f in c++ \
           cc \
           g++ \
           gcc; do
    ln -sfr "$DESTDIR/usr/bin/distcc" "$DESTDIR/usr/lib/distcc/bin/$f"
  done

  # cross-gcc wrappers
  for x in arm-linux-gnueabi \
           arm-linux-gnueabihf \
           arm-linux-musleabihf \
           armv7l-linux-gnueabihf \
           armv7l-linux-musleabihf; do
    for f in c++ \
             cc \
             g++ \
             gcc; do
      ln -sfr "$DESTDIR/usr/bin/distcc" "$DESTDIR/usr/lib/distcc/bin/$x-$f"
    done
  done
}

if [[ -z "$CROSS_BUILD" ]]; then
  distcc-pump_package() {
    depends="distcc-${version}_$revision"
    short_desc+=" - Pump mode support files"
    pycompile_module="include_server"
    pkg_install() {
      vmove usr/bin/pump
      vmove usr/share/man/man1/pump.1.gz
      vmove usr/share/man/man1/include_server.1.gz
      vmove usr/lib/python2.7
      vmove usr/share/doc/distcc/README.pump
    }
  }
fi

# vim: set filetype=sh foldmethod=marker foldlevel=0:

maintainer="nox"
pkgname="luarocks"
version=3.3.1
revision=1
short_desc="Package management for Lua modules"
archs="noarch"
depends+=" curl"
depends+=" lua"
depends+=" unzip"
hostmakedepends="lua-devel"
homepage="https://luarocks.org/"
license="MIT"
distfiles="https://luarocks.org/releases/$pkgname-$version.tar.gz"
checksum="eb20cd9814df05535d9aae98da532217c590fc07d48d90ca237e2a7cdcf284fe"
conf_files="/etc/luarocks/config-5.3.lua"
build_style="configure"
configure_args+=" --lua-version=5.3"
configure_args+=" --prefix=/usr"
configure_args+=" --sysconfdir=/etc"
configure_args+=" --versioned-rocks-dir"
configure_args+=" --with-lua-include=/usr/include/lua5.3"
alternatives+=" luarocks:luarocks:/usr/bin/luarocks-5.3"
alternatives+=" luarocks:luarocks-admin:/usr/bin/luarocks-admin-5.3"

post_extract() {
  vsed \
    -i \
    -e 's;\(unzip_found=\).*;\1/usr/bin/unzip;' \
    configure
}

post_build() {
  for lv in 5.1 \
            5.2; do
    make \
      LUA_INCDIR="/usr/include/lua$lv" \
      LUA_INTERPRETER="lua$lv" \
      LUA_VERSION="$lv" \
      "./build/config-$lv.lua"
  done
}

pre_install() {
  vsed \
    -i \
    -e 's;env lua;env lua5.3;g' \
    src/bin/luarocks{,-admin}
}

post_install() {
  vlicense COPYING

  vmkdir usr/bin
  for lv in 5.1 \
            5.2; do
    make \
      DESTDIR="$DESTDIR" \
      LUA_VERSION="$lv" \
      install-config

    echo "#!/bin/sh" > \
      "$DESTDIR/usr/bin/luarocks-$lv"
    echo "exec luarocks-5.3 --lua-version $lv \"\$@\"" >> \
      "$DESTDIR/usr/bin/luarocks-$lv"
    chmod +x "$DESTDIR/usr/bin/luarocks-$lv"

    echo "#!/bin/sh" > \
      "$DESTDIR/usr/bin/luarocks-admin-$lv"
    echo "exec luarocks-admin-5.3 --lua-version $lv \"\$@\"" >> \
      "$DESTDIR/usr/bin/luarocks-admin-$lv"
    chmod +x "$DESTDIR/usr/bin/luarocks-admin-$lv"
  done

  mv "$DESTDIR/usr/bin"/luarocks{,-5.3}
  mv "$DESTDIR/usr/bin"/luarocks-admin{,-5.3}
}

luarocks-lua52_package() {
  unset alternatives
  unset depends
  archs="noarch"
  short_desc+=" - for Lua 5.2"
  depends+=" $sourcepkg>=${version}_$revision"
  depends+=" lua52"
  conf_files="/etc/luarocks/config-5.2.lua"
  alternatives+=" luarocks:luarocks:/usr/bin/luarocks-5.2"
  alternatives+=" luarocks:luarocks-admin:/usr/bin/luarocks-admin-5.2"
  pkg_install() {
    vmove usr/bin/luarocks-5.2
    vmove usr/bin/luarocks-admin-5.2
    vmove etc/luarocks/config-5.2.lua
  }
}

luarocks-lua51_package() {
  unset alternatives
  unset depends
  archs="noarch"
  short_desc+=" - for Lua 5.1"
  depends+=" $sourcepkg>=${version}_$revision"
  depends+=" lua51"
  conf_files="/etc/luarocks/config-5.1.lua"
  alternatives+=" luarocks:luarocks:/usr/bin/luarocks-5.1"
  alternatives+=" luarocks:luarocks-admin:/usr/bin/luarocks-admin-5.1"
  pkg_install() {
    vmove usr/bin/luarocks-5.1
    vmove usr/bin/luarocks-admin-5.1
    vmove etc/luarocks/config-5.1.lua
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

_binutils_version=2.32
_gcc_version=9.3.0
_glibc_version=2.30
_linux_version=4.19

_triplet="i686-pc-linux-gnu"
_archflags="-march=i686 -mtune=generic"
_sysroot="/usr/$_triplet"

maintainer="nox"
pkgname="cross-$_triplet"
version=0.33
revision=3
short_desc="GNU Cross toolchain for the $_triplet target (binutils/gcc/glibc)"
depends="$pkgname-libc-${version}_$revision"
makedepends+=" isl15-devel"
makedepends+=" libmpc-devel"
makedepends+=" zlib-devel"
hostmakedepends+=" flex"
hostmakedepends+=" gcc-go"
hostmakedepends+=" gcc-objc"
hostmakedepends+=" perl"
hostmakedepends+=" python3"
hostmakedepends+=" tar"
homepage="https://www.voidlinux.org/"
license="GPL-2.0-or-later, GPL-3.0-or-later, LGPL-2.1-or-later"
distfiles+=" $GNU_SITE/binutils/binutils-$_binutils_version.tar.xz"
distfiles+=" $GNU_SITE/gcc/gcc-$_gcc_version/gcc-$_gcc_version.tar.xz"
distfiles+=" $GNU_SITE/glibc/glibc-$_glibc_version.tar.xz"
distfiles+=" $KERNEL_SITE/kernel/v4.x/linux-$_linux_version.tar.xz"
checksum+=" 0ab6c55dd86a92ed561972ba15b9b70a8b9f75557f896446c82e8b36e473ee04"
checksum+=" 71e197867611f6054aa1119b13a0c0abac12834765fe2d81f35ac57f84f742d1"
checksum+=" e2c4114e569afbe7edbc29131a43be833850ab9a459d81beb2588016d2bbb8af"
checksum+=" 0c68f5655528aed4f99dae71a5b259edc93239fa899e2df79c055275c21749a1"
create_wrksrc="yes"
nocross="yes"
nopie="yes"
nodebug="yes"
lib32disabled="yes"
nostrip_files+=" libcaf_single.a"
nostrip_files+=" libgcc.a"
nostrip_files+=" libgcc_eh.a"
nostrip_files+=" libgcov.a"
nostrip_files+=" libgnarl.a"
nostrip_files+=" libgnarl_pic.a"
nostrip_files+=" libgnat.a"
nostrip_files+=" libgnat_pic.a"

if [[ "$XBPS_TARGET_LIBC" != "glibc" ]]; then
  broken="glibc crosstoolchain only available on glibc"
fi

if [[ "$XBPS_TARGET_MACHINE" == "i686" ]]; then
  broken="Can't build crosstoolchain to itself"
fi

_apply_patch() {
  local args="$1"
  local pname="$(basename $2)"
  if [ ! -f ".${pname}_done" ]; then
    patch -N "$args" -i "$2"
    touch ".${pname}_done"
  fi
}

_binutils_build() {
  local _args
  [[ -f "$wrksrc/.binutils_build_done" ]] \
    && return 0

  cd "$wrksrc/binutils-$_binutils_version"

  msg_normal "Building cross binutils bootstrap\n"

  ! [[ -d "../binutils-build" ]] \
    && mkdir ../binutils-build
  cd ../binutils-build

  _args+=" --disable-multilib"
  _args+=" --disable-nls"
  _args+=" --disable-shared"
  _args+=" --disable-werror"
  _args+=" --prefix=/usr"
  _args+=" --target=$_triplet"
  _args+=" --with-sysroot=$_sysroot"
  _args+=" --with-system-zlib"

  "../binutils-$_binutils_version/configure" $_args
  make configure-host && make "$makejobs"
  make install
  touch "$wrksrc/.binutils_build_done"
}

_gcc_bootstrap() {
  local _args
  [[ -f "$wrksrc/.gcc_bootstrap_done" ]] \
    && return 0

  cd "$wrksrc/gcc-$_gcc_version"
  _apply_patch -p0 "$FILESDIR/fix-cxxflags-passing.patch"

  msg_normal "Building cross gcc bootstrap\n"

  ! [[ -d "../gcc-bootstrap" ]] \
    && mkdir ../gcc-bootstrap
  cd ../gcc-bootstrap

  # fix https://build.voidlinux.org/builders/x86_64_builder/builds/24895/steps/shell_3/logs/stdio
  export gcc_cv_libc_provides_ssp="yes"

  _args+=" $_fpuflags"
  _args+=" --disable-decimal-float"
  _args+=" --disable-libatomic"
  _args+=" --disable-libgomp"
  _args+=" --disable-libitm"
  _args+=" --disable-libmpx"
  _args+=" --disable-libmudflap"
  _args+=" --disable-libquadmath"
  _args+=" --disable-libssp"
  _args+=" --disable-multilib"
  _args+=" --disable-nls"
  _args+=" --disable-shared"
  _args+=" --disable-sjlj-exceptions"
  _args+=" --disable-threads"
  _args+=" --enable-languages=c"
  _args+=" --prefix=/usr"
  _args+=" --target=$_triplet"
  _args+=" --with-gnu-as"
  _args+=" --with-gnu-ld"
  _args+=" --without-headers"

  CFLAGS="-O0 -g0" \
  CXXFLAGS="-O0 -g0" \
    "../gcc-$_gcc_version/configure" $_args

  make "$makejobs"
  make install
  touch "$wrksrc/.gcc_bootstrap_done"
}

_linux_headers() {
  [[ -f "$wrksrc/.linux_build_done" ]] \
    && return 0

  cd "$wrksrc"
  msg_normal "Building Linux API headers for x86\n"

  cd "linux-$_linux_version"
  make ARCH="x86" headers_check
  make ARCH="x86" INSTALL_HDR_PATH="$_sysroot/usr" headers_install
  touch "$wrksrc/.linux_build_done"
}

_glibc_headers() {
  local _args f
  [[ -f "$wrksrc/.glibc_headers_done" ]] \
    && return 0

  cd "$wrksrc/glibc-$_glibc_version"
  if [[ -d "$XBPS_SRCPKGDIR/glibc/patches" ]]; then
    for f in "$XBPS_SRCPKGDIR/glibc/patches"/*.patch; do
      _apply_patch -p1 "$f"
    done
  fi

  cd "$wrksrc"
  msg_normal "Building cross glibc headers\n"

  ! [[ -d "glibc-headers" ]] \
    && mkdir glibc-headers
  cd glibc-headers

  echo "libc_cv_forced_unwind=yes" > config.cache
  echo "libc_cv_c_cleanup=yes" >> config.cache
  echo "libc_cv_ssp=no" >> config.cache

  export AS="$_triplet-as"
  export CC="$_triplet-gcc"
  export CPP="$_triplet-cpp"
  export LD="$_triplet-ld"

  _args+=" $_fpuflags"
  _args+=" --config-cache"
  _args+=" --enable-kernel=2.6.27"
  _args+=" --enable-obsolete-nsl"
  _args+=" --enable-obsolete-rpc"
  _args+=" --host=$_triplet"
  _args+=" --prefix=/usr"
  _args+=" --with-headers=$_sysroot/usr/include"

  "../glibc-$_glibc_version/configure" $_args
  make -k install-headers cross_compiling="yes" install_root="$_sysroot"
  touch "$wrksrc/.glibc_headers_done"
}

_glibc_build() {
  local _args
  [[ -f "$wrksrc/.glibc_build_done" ]] \
    && return 0

  cd "$wrksrc"
  msg_normal "Building cross glibc\n"

  ! [[ -d "glibc-build" ]] \
    && mkdir glibc-build
  cd glibc-build

  echo "libc_cv_forced_unwind=yes" > config.cache
  echo "libc_cv_c_cleanup=yes" >> config.cache
  echo "libc_cv_ssp=no" >> config.cache

  export AS="$_triplet-as"
  export CC="$_triplet-gcc"
  export CFLAGS="-O2 -pipe -Wno-error $_archflags"
  export CPP="$_triplet-cpp"
  export LD="$_triplet-ld"

  _args+=" $_fpuflags"
  _args+=" --config-cache"
  _args+=" --enable-kernel=2.6.27"
  _args+=" --enable-obsolete-nsl"
  _args+=" --enable-obsolete-rpc"
  _args+=" --host=$_triplet"
  _args+=" --prefix=/usr"
  _args+=" --with-headers=$_sysroot/usr/include"

  "../glibc-$_glibc_version/configure" $_args
  make "$makejobs"
  make install_root="$_sysroot" install
  touch "$wrksrc/.glibc_build_done"
}

_gcc_build() {
  local _args
  [[ -f "$wrksrc/.gcc_build_done" ]] \
    && return 0

  cd "$wrksrc"
  msg_normal "Building cross gcc final\n"

  ! [[ -d "gcc-build" ]] \
    && mkdir gcc-build
  cd gcc-build

  unset AS
  unset CPP
  unset LD

  # make this link to target libs
  if ! [[ -f ".sed_subst_done" ]]; then
    sed \
      -i \
      -e "s, /lib/, $_sysroot/lib/,g;s, /usr/lib/, $_sysroot/usr/lib/,g" \
      "$_sysroot/lib/libc.so" \
      "$_sysroot/lib/libpthread.so"
    touch .sed_subst_done
  fi

  _args+=" $_fpuflags"
  _args+=" --disable-libcilkrts"
  _args+=" --disable-libitm"
  _args+=" --disable-libmpx"
  _args+=" --disable-libmudflap"
  _args+=" --disable-libsanitizer"
  _args+=" --disable-libssp"
  _args+=" --disable-libstdcxx-pch"
  _args+=" --disable-libvtv"
  _args+=" --disable-multilib"
  _args+=" --disable-nls"
  _args+=" --disable-sjlj-exceptions"
  _args+=" --enable-default-pie"
  _args+=" --enable-default-ssp"
  _args+=" --enable-gnu-indirect-function"
  _args+=" --enable-gnu-unique-object"
  _args+=" --enable-languages=c,ada,c++,objc,obj-c++,go,fortran,lto"
  _args+=" --enable-libada"
  _args+=" --enable-libquadmath"
  _args+=" --enable-libstdcxx-time"
  _args+=" --enable-linker-build-id"
  _args+=" --enable-long-longx"
  _args+=" --enable-lto"
  _args+=" --enable-shared"
  _args+=" --enable-threads=posix"
  _args+=" --libexecdir=/usr/lib"
  _args+=" --prefix=/usr"
  _args+=" --target=$_triplet"
  _args+=" --target=$_triplet"
  _args+=" --with-gnu-as"
  _args+=" --with-gnu-ld"
  _args+=" --with-linker-hash-style=gnu"
  _args+=" --with-sysroot=$_sysroot"

  CC="gcc" \
  CFLAGS="-O2 -pipe" \
    "../gcc-$_gcc_version/configure" $_args

  make "$makejobs"
  touch "$wrksrc/.gcc_build_done"
}

do_build() {
  # ensure we use sane environment
  unset AR
  unset AS
  unset CC
  unset CFLAGS
  unset CPP
  unset CPPFLAGS
  unset CXX
  unset CXXFLAGS
  unset LD
  unset LDFLAGS
  unset NM
  unset OBJDUMP
  unset RANLIB
  unset READELF
  export CFLAGS="-Os"
  export CXXFLAGS="-Os"

  for f in include lib libexec bin sbin; do
    ! [[ -d "$_sysroot/usr/$f" ]] \
      && mkdir -p "$_sysroot/usr/$f"
    ! [[ -h "$_sysroot/$f" ]] \
      && ln -sfr "$_sysroot"/usr/$f "$_sysroot"/$f
  done

  _binutils_build
  _gcc_bootstrap
  _linux_headers
  _glibc_headers
  _glibc_build
  _gcc_build
}

do_install() {
  for f in include lib libexec bin sbin; do
    ! [[ -d "$DESTDIR/$_sysroot/usr/$f" ]] \
      && mkdir -p "$DESTDIR/$_sysroot/usr/$f"
    ! [[ -h "$DESTDIR/$_sysroot/$f" ]] \
      && ln -sfr "$DESTDIR/$_sysroot/usr/$f" "$DESTDIR/$_sysroot/$f"
  done

  # install cross binutils
  cd "$wrksrc/binutils-build"
  make DESTDIR="$DESTDIR" install

  # install cross gcc
  cd "$wrksrc/gcc-build"
  make DESTDIR="$DESTDIR" install

  # move libcc1.so* to the sysroot
  mv "$DESTDIR/usr/lib"/libcc1.so* "$DESTDIR/$_sysroot/usr/lib"

  # install linux API headers for x86
  cd "$wrksrc/linux-$_linux_version"
  make ARCH="x86" INSTALL_HDR_PATH="$DESTDIR/$_sysroot/usr" headers_install

  rm -f $(find "$DESTDIR/$_sysroot/usr/include" -name .install -or -name ..install.cmd)
  rm -rf "$DESTDIR/$_sysroot/usr/include/drm"

  # install glibc for target
  cd "$wrksrc/glibc-build"
  make install_root="$DESTDIR/$_sysroot" install install-headers

  # symlinks for gnarl and gnat shared libraries
  _majorver="${_gcc_version%.*.*}"
  _adalib="usr/lib/gcc/$_triplet/$_gcc_version/adalib"
  mv -v "$DESTDIR/$_adalib/libgnarl-$_majorver.so" "$DESTDIR/$_sysroot/usr/lib"
  mv -v "$DESTDIR/$_adalib/libgnat-$_majorver.so" "$DESTDIR/$_sysroot/usr/lib"
  ln -svf "libgnarl-$_majorver.so" libgnarl.so
  ln -svf "libgnat-$_majorver.so" libgnat.so
  rm -vf "$DESTDIR/$_adalib"/libgna{rl,t}.so

  # we need to build libatomic in target gcc as gccgo needs it to
  # build... but it's not needed at runtime, so remove it from the
  # destdir so it doesn't conflict with the libatomic package
  rm -f "$DESTDIR/$_sysroot/usr/lib"/libatomic.*

  # remove unnecessary stuff
  rm -f "$DESTDIR/usr"/lib*/libiberty.a
  rm -rf "$DESTDIR/usr/share"
  rm -rf "$DESTDIR/$_sysroot"/{sbin,lib,etc,var}
  rm -rf "$DESTDIR/$_sysroot/usr"/{sbin,share,libexec}
  rm -rf "$DESTDIR/$_sysroot/usr/lib/gconv"
  rm -f "$DESTDIR/$_sysroot/libexec"
}

cross-i686-pc-linux-gnu-libc_package() {
  short_desc+=" - glibc files"
  nostrip="yes"
  noverifyrdeps="yes"
  noshlibprovides="yes"
  pkg_install() {
    vmove "$_sysroot"
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

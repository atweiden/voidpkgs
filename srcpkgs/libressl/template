maintainer="nox"
pkgname="libressl"
version=3.0.2
revision=2
short_desc="Version of the TLS/crypto stack forked from OpenSSL"
homepage="http://www.libressl.org/"
license="OpenSSL-License, SSLeay-License, ISC"
changelog="https://github.com/libressl-portable/portable/raw/master/ChangeLog"
distfiles="http://ftp.openbsd.org/pub/OpenBSD/LibreSSL/$pkgname-$version.tar.gz"
checksum="df7b172bf79b957dd27ef36dcaa1fb162562c0e8999e194aa8c1a3df2f15398e"
conf_files+=" /etc/ssl/openssl.cnf"
conf_files+=" /etc/ssl/x509v3.cnf"
build_style="gnu-configure"
bootstrap="yes"
provides="openssl-${version}_$revision"
replaces="openssl>=0"

if [[ "$XBPS_TARGET_MACHINE" == "i686-musl" ]]; then
  # XXX disable SSP
  configure_args+=" --disable-hardening"
elif [[ "$XBPS_TARGET_MACHINE" == "armv5tel" ]]; then
  configure_args+=" --disable-asm"
fi

if [[ -n "$CROSS_BUILD" ]]; then
  hostmakedepends+=" automake"
  hostmakedepends+=" libtool"
  pre_configure() {
    autoreconf -fi
  }
fi

post_install() {
  vlicense COPYING
  # use CA file from ca-certificates instead
  rm -f "$DESTDIR/etc/ssl/cert.pem"
  ln -s certs.pem "$DESTDIR/etc/ssl/cert.pem"
  find "$DESTDIR/usr/share/man/man1" -type f ! -name openssl.1 -delete
}

libcrypto45_package() {
  short_desc+=" - crypto library"
  pkg_install() {
    vmove "usr/lib/libcrypto.so.*"
  }
}

libssl47_package() {
  short_desc+=" - SSL/TLS library"
  pkg_install() {
    vmove "usr/lib/libssl.so.*"
  }
}

libtls19_package() {
  short_desc+=" - new TLS library"
  pkg_install() {
    vmove "usr/lib/libtls.so.*"
  }
}

libressl-devel_package() {
  short_desc+=" - development files"
  depends+=" libcrypto45-${version}_$revision"
  depends+=" libssl47-${version}_$revision"
  depends+=" libtls19-${version}_$revision"
  pkg_install() {
    vmove usr/include
    vmove "usr/lib/*.a"
    vmove "usr/lib/*.so"
    vmove usr/lib/pkgconfig
    vmove usr/share/man/man3
  }
}

libressl-netcat_package() {
  short_desc="TCP/IP swiss army knife (LibreSSL variant)"
  alternatives+=" nc:nc:/usr/bin/libressl-nc"
  alternatives+=" nc:nc.1:/usr/share/man/man1/libressl-nc.1"
  pkg_install() {
    vbin apps/nc/.libs/nc libressl-nc
    vman apps/nc/nc.1 libressl-nc.1
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

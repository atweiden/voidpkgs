maintainer="nox"
pkgname="chez-scheme"
version=9.5.8
revision=1
short_desc="Compiler and run-time system for R6RS Scheme"
archs+=" armv6l"
archs+=" armv7l"
archs+=" i686*"
archs+=" x86_64*"
makedepends+=" git"
makedepends+=" liblz4-devel"
makedepends+=" libuuid-devel"
makedepends+=" ncurses-devel"
makedepends+=" zlib-devel"
hostmakedepends="$makedepends"
homepage="https://scheme.com/"
license="Apache-2.0"
distfiles="https://github.com/cisco/ChezScheme/releases/download/v$version/csv$version.tar.gz>$pkgname-$version.tar.gz"
checksum="af83e80cbfe1a9a7c868e7c069a40c449fadd5e2a1737fd0f1260fc9d4159906"
wrksrc="csv$version"
build_style="gnu-configure"
configure_args="--disable-x11"
alternatives+=" scheme:scheme.1:/usr/share/man/man1/chez-scheme.1"
alternatives+=" scheme:scheme:/usr/bin/chez-scheme"

case "$XBPS_MACHINE" in
  i686*)
    _host="ti3le"
    ;;
  x86_64*)
    _host="ta6le"
    ;;
  arm*)
    # no threading makefile
    _host="arm32le"
    ;;
  *)
    broken="unsupported host platform"
    ;;
esac

case "$XBPS_TARGET_MACHINE" in
  i686*)
    _target="ti3le"
    ;;
  x86_64*)
    _target="ta6le"
    ;;
  arm*)
    _target="arm32le"
    ;;
  *)
    broken="unsupported target platform"
    ;;
esac

do_configure() {
  # configure such that scheme uses the zlib and lz4 system shared libs
  # ZLIB and LZ4 are used when building the scheme kernel and use the
  # full path
  # LDFLAGS is extended in 'do_build' so that the rest of the scheme
  # system links them
  ./configure \
    --installman="/usr/share/man" \
    --installprefix="/usr" \
    --installschemename="chez-scheme" \
    --machine="$_host" \
    --nogzip-man-pages \
    --temproot="$DESTDIR" \
    ZLIB="-L/usr/lib/libz.so" \
    LZ4="-L/usr/lib/liblz4.so"
}

post_install() {
  # make link relative
  ln -sf \
    scheme.boot \
    "$DESTDIR/usr/lib"/csv*/*/scheme-script.boot
}

if [[ -n "$CROSS_BUILD" ]]; then

do_build() {
  # build host/bootstrap scheme compiler
  make \
    "$makejobs" \
    CC="$BUILD_CC" \
    CFLAGS="$BUILD_CFLAGS" \
    LD="$BUILD_LD" \
    LDFLAGS="-lz -llz4 $BUILD_LDFLAGS"

  ./workarea "$_target"

  # use Mf-config created from 'do_configure'
  # this is required - the build fails to include the scheme kernel
  # when this is missing
  cd "$_target/c"
  ln -sf "../../$_host/c/Mf-config" .
  cd ..

  # cross compile to target
  make \
    "$makejobs" \
    -C s \
    -f Mf-cross \
    base="../../$_host" \
    m="$_host" \
    xm="$_target"

  make \
    "$makejobs" \
    -C c \
    CC="$CC" \
    CFLAGS="$CFLAGS" \
    LD="$LD" \
    LDFLAGS="-lz -llz4 $LDFLAGS"
}

do_install() {
  cd "$_target"
  make \
    -f "../$_host/Mf-install" \
    DESTDIR="$DESTDIR" \
    m="$_target"
}

else

do_build() {
  make \
    "$makejobs" \
    CC="$CC" \
    CFLAGS="$CFLAGS" \
    LD="$LD" \
    LDFLAGS="-lz -llz4 $LDFLAGS"
}

do_install() {
  make \
    DESTDIR="$DESTDIR" \
    install
}

fi

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

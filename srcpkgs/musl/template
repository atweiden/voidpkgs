maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="musl"
version=1.1.20
revision=1
short_desc="The musl C library"
only_for_archs+=" aarch64-musl"
only_for_archs+=" armv5tel-musl"
only_for_archs+=" armv6l-musl"
only_for_archs+=" armv7l-musl"
only_for_archs+=" i686-musl"
only_for_archs+=" mips-musl"
only_for_archs+=" mipsel-musl"
only_for_archs+=" mipselhf-musl"
only_for_archs+=" mipshf-musl"
only_for_archs+=" x86_64-musl"
homepage="http://www.musl-libc.org/"
license="MIT"
distfiles="http://www.musl-libc.org/releases/musl-$version.tar.gz"
checksum="44be8771d0e6c6b5f82dd15662eb2957c9a3173a19a8b49966ac0542bbd40d61"
build_style="gnu-configure"
configure_args+=" --disable-gcc-wrapper"
configure_args+=" --prefix=/usr"
nostrip_files="libc.so"
shlib_provides="libc.so"
bootstrap="yes"
desc_option_bigstack="bigger default pthread stack size"
build_options="bigstack"
conflicts="glibc>=0"

CFLAGS="$(vopt_if bigstack -DVOID_BIGSTACK)"

post_build() {
  "$CC" "$CFLAGS" "$LDFLAGS" "$FILESDIR/getent.c" -o getent
  "$CC" "$CFLAGS" "$LDFLAGS" "$FILESDIR/getconf.c" -o getconf
  "$CC" "$CFLAGS" "$LDFLAGS" "$FILESDIR/iconv.c" -o iconv
}

do_install() {
  # move everything to /usr
  vmkdir usr/lib
  ln -sfr "$DESTDIR/usr/lib" "$DESTDIR/lib"
  make DESTDIR="$DESTDIR" install
  rm "$DESTDIR/lib"
  # provide ldd
  vmkdir usr/bin
  ln -s /usr/lib/libc.so "$DESTDIR/usr/bin/ldd"
  # additional utils from Alpine/NetBSD
  vbin iconv
  vbin getent
  vman "$FILESDIR/getent.1"
  vbin getconf
  vman "$FILESDIR/getconf.1"
  # fake ldconfig
  ln -s true "$DESTDIR/usr/bin/ldconfig"
  # create xbps.d(5) arch override file
  vmkdir usr/share/xbps.d
  echo "architecture=$XBPS_TARGET_MACHINE" > "$DESTDIR/usr/share/xbps.d/musl-arch.conf"
}

post_install() {
  vlicense COPYRIGHT
}

musl-devel_package() {
  depends+=" $sourcepkg-${version}_$revision"
  depends+=" kernel-libc-headers"
  short_desc+=" - development files"
  pkg_install() {
    vmove usr/include
    vmove "usr/lib/*.a"
    vmove "usr/lib/*.o"
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

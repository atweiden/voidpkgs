maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="musl"
version=1.1.21
revision=1
short_desc="The musl C library"
archs="*-musl"
homepage="http://www.musl-libc.org/"
license="MIT"
distfiles="http://www.musl-libc.org/releases/$pkgname-$version.tar.gz"
checksum="c742b66f6f49c9e5f52f64d8b79fecb5a0f6e0203fca176c70ca20f6be285f44"
build_style="gnu-configure"
configure_args+=" --disable-gcc-wrapper"
configure_args+=" --prefix=/usr"
nostrip_files="libc.so"
shlib_provides="libc.so"
bootstrap="yes"
conflicts="glibc>=0"

post_build() {
  "$CC" "$CFLAGS" "$LDFLAGS" "$FILESDIR/getent.c" -o getent
  "$CC" "$CFLAGS" "$LDFLAGS" "$FILESDIR/getconf.c" -o getconf
  "$CC" "$CFLAGS" "$LDFLAGS" "$FILESDIR/iconv.c" -o iconv
}

do_install() {
  # move everything to /usr
  vmkdir usr/lib
  ln -sfr "$DESTDIR/usr/lib" "$DESTDIR/lib"
  make DESTDIR="$DESTDIR" install
  rm "$DESTDIR/lib"
  # provide ldd
  vmkdir usr/bin
  ln -s /usr/lib/libc.so "$DESTDIR/usr/bin/ldd"
  # additional utils from Alpine/NetBSD
  vbin iconv
  vbin getent
  vman "$FILESDIR/getent.1"
  vbin getconf
  vman "$FILESDIR/getconf.1"
  # fake ldconfig
  ln -s true "$DESTDIR/usr/bin/ldconfig"
  # create xbps.d(5) arch override file
  vmkdir usr/share/xbps.d
  echo "architecture=$XBPS_TARGET_MACHINE" > "$DESTDIR/usr/share/xbps.d/musl-arch.conf"
}

post_install() {
  vlicense COPYRIGHT
}

musl-devel_package() {
  depends+=" $sourcepkg-${version}_$revision"
  depends+=" kernel-libc-headers"
  short_desc+=" - development files"
  pkg_install() {
    vmove usr/include
    vmove "usr/lib/*.a"
    vmove "usr/lib/*.o"
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

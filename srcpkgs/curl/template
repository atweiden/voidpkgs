maintainer="nox"
pkgname="curl"
version=7.68.0
revision=1
short_desc="Client that groks URLs"
depends="ca-certificates"
makedepends+=" nghttp2-devel"
makedepends+=" zlib-devel"
makedepends+=" $(vopt_if gnutls gnutls-devel)"
makedepends+=" $(vopt_if gssapi mit-krb5-devel)"
makedepends+=" $(vopt_if ldap libldap-devel)"
makedepends+=" $(vopt_if rtmp librtmp-devel)"
makedepends+=" $(vopt_if ssh libssh2-devel)"
makedepends+=" $(vopt_if ssl libressl-devel)"
checkdepends="python3"
hostmakedepends+=" groff"
hostmakedepends+=" perl"
hostmakedepends+=" pkg-config"
homepage="https://curl.haxx.se"
license="MIT"
changelog="https://curl.haxx.se/changes.html#${version//./_}"
distfiles="https://curl.haxx.se/download/$pkgname-$version.tar.bz2"
checksum="207f54917dd6a2dc733065ccf18d61bb5bebeaceb5df49cd9445483e8623eeb9"
build_style="gnu-configure"
configure_args+=" --enable-ipv6"
configure_args+=" --enable-threaded-resolver"
configure_args+=" --with-ca-bundle=/etc/ssl/certs/ca-certificates.crt"
configure_args+=" --without-libidn2"
configure_args+=" ac_cv_sizeof_off_t=8"
configure_args+=" $(vopt_enable ldap ldaps)"
configure_args+=" $(vopt_enable ldap)"
configure_args+=" $(vopt_with gnutls)"
configure_args+=" $(vopt_with gssapi)"
configure_args+=" $(vopt_with rtmp)"
configure_args+=" $(vopt_with ssh libssh2)"
configure_args+=" $(vopt_with ssl)"
build_options+=" gnutls"
build_options+=" gssapi"
build_options+=" ldap"
build_options+=" rtmp"
build_options+=" ssh"
build_options+=" ssl"
build_options_default+=" ssh"
build_options_default+=" ssl"

vopt_conflict "ssl" "gnutls"

pre_configure() {
  export CFLAGS="${CFLAGS/-D_FORTIFY_SOURCE=2/}"
  export CFLAGS="${CFLAGS/-I$XBPS_CROSS_BASE\/usr\/include/}"
  export CPPFLAGS="-D_FORTIFY_SOURCE=2"
}

post_install() {
  vlicense COPYING
}

libcurl_package() {
  short_desc="Multiprotocol file transfer library"
  shlib_provides="libcurl-gnutls.so.4"
  pkg_install() {
    vmove "usr/lib/*.so.*"
    ln -sf libcurl.so.4.6.0 "$PKGDESTDIR/usr/lib/libcurl-gnutls.so.4"
  }
}
libcurl-devel_package() {
  unset depends
  depends+=" $makedepends"
  depends+=" libcurl>=${version}_$revision"
  short_desc="Multiprotocol file transfer library - development files"
  pkg_install() {
    vmove usr/bin/curl-config
    vmove "usr/share/man/man1/curl-config*"
    vmove usr/share/man/man3
    vmove usr/share/aclocal
    vmove usr/include
    vmove "usr/lib/*.a"
    vmove "usr/lib/*.so"
    vmove usr/lib/pkgconfig
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

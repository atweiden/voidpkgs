maintainer="nox"
pkgname="avahi"
version=0.7
revision=8
short_desc="Multicast DNS Service Discovery"
makedepends+=" dbus-devel"
makedepends+=" gdbm-devel"
makedepends+=" libcap-devel"
makedepends+=" libdaemon-devel"
hostmakedepends+=" intltool"
hostmakedepends+=" pkg-config"
hostmakedepends+=" python"
homepage="https://github.com/lathiat/avahi"
license="LGPL-2.1-or-later"
distfiles="https://github.com/lathiat/avahi/releases/download/v$version/$pkgname-$version.tar.gz"
checksum="57a99b5dfe7fdae794e3d1ee7a62973a368e91e414bd0dfa5d84434de5b14804"
conf_files+=" /etc/avahi/avahi-daemon.conf"
conf_files+=" /etc/avahi/avahi-dnsconfd.action"
conf_files+=" /etc/avahi/hosts"
conf_files+=" /etc/avahi/services/sftp-ssh.service"
conf_files+=" /etc/avahi/services/ssh.service"
build_style="gnu-configure"
configure_args+=" --disable-dbm"
configure_args+=" --disable-doxygen-doc"
configure_args+=" --disable-glib"
configure_args+=" --disable-gobject"
configure_args+=" --disable-gtk"
configure_args+=" --disable-gtk3"
configure_args+=" --disable-introspection"
configure_args+=" --disable-mono"
configure_args+=" --disable-monodoc"
configure_args+=" --disable-pygobject"
configure_args+=" --disable-python-dbus"
configure_args+=" --disable-qt3"
configure_args+=" --disable-qt4"
configure_args+=" --disable-static"
configure_args+=" --disable-xmltoman"
configure_args+=" --enable-compat-howl"
configure_args+=" --enable-compat-libdns_sd"
configure_args+=" --enable-python"
configure_args+=" --with-autoipd-group=avahi"
configure_args+=" --with-autoipd-user=avahi"
configure_args+=" --with-avahi-group=avahi"
configure_args+=" --with-avahi-priv-access-group=network"
configure_args+=" --with-avahi-user=avahi"
configure_args+=" --with-distro=none"
configure_args+=" --with-xml=expat"
configure_args+=" ssp_cv_lib=no"
system_accounts="avahi:23"

if [[ -n "$CROSS_BUILD" ]]; then
  hostmakedepends+=" automake"
  hostmakedepends+=" glib-devel"
  hostmakedepends+=" libtool"
  pre_configure() {
    autoreconf -if
  }
fi

post_extract() {
  # switch to /run to not depend on /var/run being a symlink
  sed \
    -i \
    -e 's,\(avahi_runtime_dir=\).*,\1\"/run\",' \
    "$wrksrc/configure"
}

post_install() {
  rm -rf "$DESTDIR/usr/lib"/python*
  # enable 'disallow_other_stacks' option by default
  sed \
    -i \
    -e 's,\#\(disallow-other-stacks\).*,\1=yes,' \
    "$DESTDIR/etc/avahi/avahi-daemon.conf"
  # set 'enable-dbus=warn' option by default to not require dbus
  sed \
    -i \
    -e 's,\#\(enable-dbus\).*,\1=warn,' \
    "$DESTDIR/etc/avahi/avahi-daemon.conf"
  vsv avahi-daemon
}

avahi-autoipd_package() {
  depends="net-tools"
  short_desc="Avahi IPv4LL network address configuration daemon"
  pkg_install() {
    vmove usr/bin/avahi-autoipd
    vmove "usr/share/man/man8/avahi-autoipd*"
    vmove etc/avahi/avahi-autoipd.action
  }
}

avahi-compat-libs-devel_package() {
  depends+=" avahi-compat-libs-${version}_$revision"
  depends+=" avahi-libs-devel-${version}_$revision"
  short_desc="Avahi compat libraries - development files"
  pkg_install() {
    vmove "usr/include/avahi-compat*"
    vmove "usr/lib/pkgconfig/avahi-compat*"
    vmove usr/lib/libhowl.so
    vmove usr/lib/libdns_sd.so
  }
}

avahi-compat-libs_package() {
  short_desc="Avahi compatiblity shared libraries"
  pkg_install() {
    vmove "usr/lib/libhowl.so.*"
    vmove "usr/lib/libdns_sd.so.*"
  }
}

avahi-libs-devel_package() {
  depends+=" avahi-libs-${version}_$revision"
  depends+=" dbus-devel"
  short_desc="Avahi core libraries - development files"
  pkg_install() {
    for f in client \
             common \
             core; do
      vmove "usr/include/avahi-$f"
    done
    vmove usr/lib/pkgconfig/avahi-core.pc
    vmove usr/lib/pkgconfig/avahi-client.pc
    vmove usr/lib/libavahi-client.so
    vmove usr/lib/libavahi-core.so
    vmove usr/lib/libavahi-common.so
  }
}

avahi-libs_package() {
  short_desc="Avahi shared libraries"
  pkg_install() {
    vmove "usr/lib/libavahi-client.so.*"
    vmove "usr/lib/libavahi-core.so.*"
    vmove "usr/lib/libavahi-common.so.*"
  }
}

avahi-utils_package() {
  short_desc="Avahi browsing, publishing and discovery utilities"
  pkg_install() {
    vmove "usr/bin/avahi-browse*"
    vmove "usr/bin/avahi-publish*"
    vmove "usr/bin/avahi-resolv*"
    vmove usr/share/man/man1
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

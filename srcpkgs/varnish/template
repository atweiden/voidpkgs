maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="varnish"
version=6.1.1
revision=4
short_desc="A fast caching HTTP reverse proxy"
makedepends+=" pcre-devel"
makedepends+=" readline-devel"
hostmakedepends+=" pkg-config"
hostmakedepends+=" python"
hostmakedepends+=" python-Sphinx"
hostmakedepends+=" python-docutils"
homepage="https://varnish-cache.org/"
license="BSD-2-Clause"
distfiles="https://varnish-cache.org/_downloads/varnish-$version.tgz"
checksum="e0ee7c88a8149d8890b26fd9e1d909859ea895a39ca188d76a96869cff87c93d"
conf_files="/etc/varnish/default.vcl"
build_style="gnu-configure"
configure_args+=" --disable-static"
configure_args+=" --enable-asan"
configure_args+=" --enable-msan"
configure_args+=" --enable-tsan"
configure_args+=" --enable-ubsan"
configure_args+=" --with-gnu-ld"
configure_args+=" --without-jemalloc"
make_dirs="/var/varnish 750 nobody nogroup"
lib32disabled="yes"
nocross="Cannot run test program when cross compiling (PCRE_JIT)"

case "$XBPS_TARGET_MACHINE" in
  *-musl)
    makedepends+=" libexecinfo-devel"
    broken="Segfaults when running ../../bin/varnishd/varnishd -x cli > include/cli.rst"
    ;;
esac

post_install() {
  vlicense LICENSE
  vinstall etc/example.vcl 644 etc/varnish default.vcl
  vsv varnishd
}

libvarnishapi_package() {
  short_desc+=" - API runtime library"
  pkg_install() {
    vmove "usr/lib/*.so.*"
  }
}

libvarnishapi-devel_package() {
  depends="libvarnishapi>=${version}_$revision"
  short_desc+=" - API development files"
  pkg_install() {
    vmove usr/include
    vmove usr/lib/pkgconfig
    vmove "usr/lib/*.so"
    vmove usr/share/man/man3
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

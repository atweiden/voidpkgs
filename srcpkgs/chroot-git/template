maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="chroot-git"
version=2.23.0
revision=3
short_desc="GIT Tree History Storage Tool - for xbps-src use"
makedepends="zlib-devel"
homepage="https://git-scm.com/"
license="GPL-2.0-only"
distfiles="https://www.kernel.org/pub/software/scm/git/${pkgname#chroot-}-$version.tar.xz"
checksum="234fa05b6839e92dc300b2dd78c92ec9c0c8d439f65e1d430a7034f60af16067"
wrksrc="git-$version"
build_style="gnu-configure"
configure_args+=" --without-curl"
configure_args+=" --without-expat"
configure_args+=" --without-openssl"
configure_args+=" --without-python"
configure_args+=" --without-tcltk"
configure_args+=" ac_cv_lib_curl_curl_global_init=no"
configure_args+=" ac_cv_lib_expat_XML_ParserCreate=no"
configure_args+=" ac_cv_snprintf_returns_bogus=no"
bootstrap="yes"

if [[ -n "$CHROOT_READY" ]]; then
  hostmakedepends="perl"
else
  configure_args+=" --with-zlib=$XBPS_MASTERDIR/usr"
fi

case "$XBPS_TARGET_MACHINE" in
  *-musl)
    configure_args+=" ac_cv_fread_reads_directories=yes"
    ;;
  *)
    configure_args+=" ac_cv_fread_reads_directories=no"
    ;;
esac

post_configure() {
  cat <<-EOF >config.mak
  CC_LD_DYNPATH=-L
  NO_INSTALL_HARDLINKS=Yes
  EOF
  case "$XBPS_TARGET_MACHINE" in
    *-musl)
      echo "ICONV_OMITS_BOM=Yes" >>config.mak
      ;;
  esac
}

do_install() {
  # remove unneeded stuff
  make DESTDIR="$wrksrc/build-tmp" install
  vbin "$wrksrc/build-tmp/usr/bin/git" chroot-git
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

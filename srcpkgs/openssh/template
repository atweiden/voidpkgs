maintainer="nox"
pkgname="openssh"
version=8.1p1
revision=2
short_desc="OpenSSH free Secure Shell (SSH) client and server implementation"
makedepends+=" libedit-devel"
makedepends+=" pam-devel"
makedepends+=" zlib-devel"
makedepends+=" $(vopt_if gssapi mit-krb5-devel)"
makedepends+=" $(vopt_if ldns libldns-devel)"
makedepends+=" $(vopt_if ssl libressl-devel)"
hostmakedepends="autoconf"
homepage="https://www.openssh.com"
license="BSD-2-Clause, ISC"
distfiles="https://ftp.openbsd.org/pub/OpenBSD/OpenSSH/portable/$pkgname-$version.tar.gz"
checksum="02f5dbef3835d0753556f973cd57b4c19b6b1f6cd24c03445e23ac77ca1b93ff"
conf_files+=" /etc/pam.d/sshd"
conf_files+=" /etc/ssh/moduli"
conf_files+=" /etc/ssh/ssh_config"
conf_files+=" /etc/ssh/sshd_config"
build_style="gnu-configure"
configure_args+=" --datadir=/usr/share/openssh"
configure_args+=" --disable-strip"
configure_args+=" --sysconfdir=/etc/ssh"
configure_args+=" --with-Werror"
configure_args+=" --with-libedit"
configure_args+=" --with-mantype=doc"
configure_args+=" --with-pam"
configure_args+=" --with-pid-dir=/run"
configure_args+=" --with-privsep-path=/var/chroot/ssh"
configure_args+=" --with-privsep-user=nobody"
configure_args+=" --with-xauth=/usr/bin/xauth"
configure_args+=" --without-rpath"
configure_args+=" --without-selinux"
configure_args+=" LD=$CC"
configure_args+=" ac_cv_header_sys_cdefs_h=false"
configure_args+=" $(vopt_with ldns ldns=$XBPS_CROSS_BASE/usr)"
configure_args+=" $(vopt_if ssl --with-ssl-engine --without-openssl)"
configure_args+=" $(vopt_if gssapi --with-kerberos5=$XBPS_CROSS_BASE/usr --without-kerberos5)"
make_dirs="/var/chroot/ssh 0755 root root"
build_options+=" gssapi"
build_options+=" ldns"
build_options+=" ssl"
build_options_default+=" ldns"
build_options_default+=" ssl"

CFLAGS="-Wno-format-truncation -Wno-stringop-truncation"

case $XBPS_TARGET_MACHINE in
  i686-musl)
    CFLAGS+=" -fno-stack-protector"
    configure_args+=" --disable-utmp"
    configure_args+=" --disable-wtmp"
    ;;
  *-musl)
    configure_args+=" --disable-utmp"
    configure_args+=" --disable-wtmp"
    ;;
esac

pre_configure() {
  autoreconf -fi
  vsed \
    -i \
    -e 's|#include <sys/sysctl.h>||' \
    servconf.c
}

post_install() {
  vlicense LICENCE
  vman contrib/ssh-copy-id.1
  vinstall contrib/sshd.pam.generic 644 etc/pam.d sshd
  vbin contrib/ssh-copy-id

  # configure to use PAM
  vsed \
    -i \
    -e 's|^#\(UsePAM\) no|\1 yes|g' \
    -e 's|^#\(ChallengeResponseAuthentication\) yes|\1 no|g' \
    -e 's|^#\(PrintMotd\) yes|\1 no|g' \
    "$DESTDIR/etc/ssh/sshd_config"

  vinstall "$FILESDIR/sshd.pam" 644 etc/pam.d sshd
  vsv sshd
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

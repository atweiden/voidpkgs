maintainer="nox"
pkgname="ecl"
version=21.2.1
revision=1
short_desc="Common-Lisp interpreter as described in the X3J13 Ansi specification"
depends+=" gc-devel"
depends+=" gmp-devel"
depends+=" libatomic_ops-devel"
depends+=" libffi-devel"
makedepends="$depends"
hostmakedepends="pkg-config"
homepage="https://common-lisp.net/project/ecl/"
license="LGPL-2.1-or-later"
distfiles="https://common-lisp.net/project/ecl/static/files/release/$pkgname-$version.tgz"
checksum="b15a75dcf84b8f62e68720ccab1393f9611c078fcd3afdd639a1086cad010900"
build_style="gnu-configure"
configure_args+=" --enable-boehm=system"
configure_args+=" --enable-gmp=system"
configure_args+=" --enable-libatomic=system"
configure_args+=" --with-dffi=system"

if [[ -n "$CROSS_BUILD" ]]; then
  # depend on system ecl
  hostmakedepends+=" ecl"
  configure_args+=" --with-cross-config=$XBPS_SRCPKGDIR/ecl/files/cross_config"
fi

pre_check() {
  # These settings enable `make check` to run using the compiled ecl.
  # A few tests fail: out of 18098 tests there are ~10 that fail on
  # glibc and an additional ~30 fail on musl (the numbers vary as
  # some failures seem random.)
  #
  # The build finishes since `make check` does NOT fail; it is left
  # for the future to fix the failing tests and patch make check so
  # it actually fails the build.
  export ECLDIR="$wrksrc/build/"
  export LD_LIBRARY_PATH="$wrksrc/build/"
  export TEST_IMAGE="$wrksrc/build/bin/ecl"
  make_check_args="ECL=$TEST_IMAGE"
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

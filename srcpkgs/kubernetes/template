maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="kubernetes"
version=1.17.0
revision=1
short_desc="Container Cluster Manager for Docker"
archs+=" ppc64le*"
archs+=" x86_64*"
depends="kubectl"
hostmakedepends+=" git"
hostmakedepends+=" go-bindata"
hostmakedepends+=" rsync"
homepage="http://kubernetes.io"
license="Apache-2.0"
distfiles="https://github.com/kubernetes/kubernetes/archive/v$version.tar.gz>$pkgname-$version.tar.gz"
checksum="b4f82f5006ff945edc17726ac93489173876313855020e7760b1c189fb402bb1"
conf_files="/etc/kubernetes/*"
build_style="go"
go_import_path="github.com/kubernetes/kubernetes"
system_accounts="kube"
make_dirs="/var/lib/kubelet 0755 kube kube"
nocross="yes"

export GOFLAGS="-trimpath"

do_build() {
  make
  hack/generate-docs.sh
  find "_output/local/bin/linux/" -type f -executable \
    | grep "kubectl" \
    | egrep -v "gen|test" \
    | while read line; do
      $line completion bash > completion.bash
      $line completion zsh > completion.zsh
      break
  done
}

do_install() {
  find "_output/local/bin/linux/" -type f -executable \
    | grep "kube" \
    | egrep -v "gen|test" \
    | while read line; do
      vbin "$line"
  done
}

post_install() {
  vlicense LICENSE
  for _man in docs/man/man1/*.1; do
    vman "$_man"
  done
  vmkdir etc/kubernetes
  vcopy "$FILESDIR/environ/*" etc/kubernetes
  vsv kube-apiserver
  vsv kube-controller-manager
  vsv kubelet
  vsv kube-scheduler
  vsv kube-proxy
}

kubectl_package() {
  short_desc="Controls the Kubernetes cluster manager"
  pkg_install() {
    vmove usr/bin/kubectl
    vlicense LICENSE
    vmove "usr/share/man/man1/kubectl*"
    vinstall completion.bash 644 usr/share/bash-completion/completions kubectl
    vinstall completion.zsh 644 usr/share/kubectl
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

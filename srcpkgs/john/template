maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="john"
version=1.8.0
revision=13
_jumbover=1
short_desc="John the Ripper password cracker (jumbo-$_jumbover patch included)"
makedepends+=" gmp-devel"
makedepends+=" libgomp-devel"
makedepends+=" libpcap-devel"
makedepends+=" libressl-devel"
makedepends+=" zlib-devel"
hostmakedepends+=" libgomp-devel"
hostmakedepends+=" pkg-config"
homepage="http://www.openwall.com/john/"
license="GPL-2"
distfiles="http://www.openwall.com/john/j/$pkgname-$version-jumbo-$_jumbover.tar.xz"
checksum="bac93d025995a051f055adbd7ce2f1975676cac6c74a6c7a3ee4cfdd9c160923"
conf_files="/etc/john/john.conf"
wrksrc="$pkgname-$version-jumbo-$_jumbover"
build_wrksrc="src"
build_style="gnu-configure"
configure_args="--disable-native-tests --disable-native-macro"

pre_configure() {
  # SHA no longer available in libressl
  rm rawSHA0_fmt_plug.c
  sed \
    -i \
    -e 's|des_|DES_|g' \
    KRB4*.c
  sed \
    -i \
    -e 's|^$CPP|$CC -E|' \
    configure
  export AS=
  export LD=
  export OPENSSL_LIBS="-lssl -lcrypto"
  CFLAGS+=" -DJOHN_SYSTEMWIDE=1"
}

do_install() {
  cd ..

  # install config file
  sed \
    -i \
    -e 's|$JOHN|/usr/share/john|g' \
    run/john.conf
  install -Dm 644 run/john.conf "$DESTDIR/etc/john/john.conf"

  # install docs
  vmkdir usr/share/doc/john
  vmkdir usr/share/licenses/john
  install -m 644 doc/* "$DESTDIR/usr/share/doc/john"
  vmkdir usr/share/john
  mv \
    "$DESTDIR/usr/share/doc/$pkgname/LICENSE" \
    "$DESTDIR/usr/share/licenses/$pkgname"

  # install password list and charset files
  install -m 644 run/*.chr run/*.lst "$DESTDIR/usr/share/john"
  install -m 644 run/*.conf "$DESTDIR/usr/share/john"

  # install binaries
  vbin run/john
  vbin run/mailer john-mailer
  vbin run/vncpcap2john
  vbin run/luks2john
  cd "$DESTDIR/usr/bin"
  ln -s john unafs
  ln -s john unique
  ln -s john unshadow
  ln -s john undrop
  ln -s john gpg2john
  ln -s john pdf2john
  ln -s john rar2john
  ln -s john ssh2john
  ln -s john zip2john
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

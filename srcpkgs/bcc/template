maintainer="nox"
pkgname="bcc"
version=0.21.0
revision=4
short_desc="BPF-based Linux IO analysis, networking, monitoring, and more"
makedepends+=" clang"
makedepends+=" clang-tools-extra"
makedepends+=" elfutils-devel"
makedepends+=" flex"
makedepends+=" lld-devel"
makedepends+=" llvm"
makedepends+=" ncurses-devel"
makedepends+=" python3-devel"
makedepends+=" zlib-devel"
if [[ -n "$XBPS_TARGET_NO_ATOMIC8" ]]; then
  makedepends+=" libatomic-devel"
fi
hostmakedepends+=" flex"
hostmakedepends+=" python3"
homepage="https://github.com/iovisor/bcc"
license="Apache-2.0"
# use a newer libbpf to fix compile issues on various targets
# you should be able to drop this for the next update
distfiles+=" https://github.com/iovisor/bcc/releases/download/v$version/$pkgname-src-with-submodule.tar.gz>$pkgname-$version.tar.gz"
distfiles+=" https://github.com/libbpf/libbpf/archive/506a544834573905ada61da8e00f54b04f0caf43.tar.gz"
checksum+=" 5323e2a505f6868976d973a234202332ec25dc36f0bf7c118c23fc24f6147215"
checksum+=" e1db8edc20997270a7d7c4d6e5d881abb941828601f113866ebb4073168c1f87"
wrksrc="$pkgname"
build_style="cmake"
configure_args+=" -DENABLE_LLVM_SHARED=1"
configure_args+=" -DREVISION=$version"
python_version=3

post_extract() {
  # break on musl
  sed \
    -i \
    -e '/tests/d' \
    CMakeLists.txt
  sed \
    -i \
    -e 's/<error.h>/<errno.h>/' \
    examples/cpp/KModRetExample.cc

  # use a newer libbpf with fixes
  rm -rf src/cc/libbpf
  mv ../libbpf* src/cc/libbpf
}

bcc-tools_package() {
  short_desc+=" - tools"
  depends="python3-bcc>=${version}_$revision"
  case "$XBPS_TARGET_MACHINE" in
    # only add linux-headers for archs it's currently built for
    i686*|x86_64*|ppc*|aarch64*)
      depends+=" linux-headers"
      ;;
  esac
  pkg_install() {
    vmove usr/share/bcc/man/man8
    mv "$PKGDESTDIR/usr/share/bcc/man" "$PKGDESTDIR/usr/share/man"
    gunzip "$PKGDESTDIR/usr/share/man"/*/*.gz
    vmkdir usr/share/doc
    vmove usr/share/bcc/tools
    mv "$PKGDESTDIR/usr/share/bcc/tools/doc" "$PKGDESTDIR/usr/share/doc/bcc-tools"
    mv "$PKGDESTDIR/usr/share/bcc/tools" "$PKGDESTDIR/usr/bin"
    rm -rf "$PKGDESTDIR/usr/bin/old"
    mv "$PKGDESTDIR/usr/bin/lib"/* "$PKGDESTDIR/usr/bin"
    rm -rf "$PKGDESTDIR/usr/bin/lib"
    rm -f "$PKGDESTDIR/usr/bin"/*.c
    vmove usr/share/bcc/introspection
    vbin "$PKGDESTDIR/usr/share/bcc/introspection/bps"
    rm -rf "$PKGDESTDIR/usr/share/bcc/introspection"
    mv "$PKGDESTDIR/usr/bin/trace" "$PKGDESTDIR/usr/bin/trace-bcc"
    mv "$PKGDESTDIR/usr/share/man/man8/trace.8" "$PKGDESTDIR/usr/share/man/man8/trace-bcc.8"
  }
}

bcc-devel_package() {
  short_desc+=" - development files"
  depends="$sourcepkg>=${version}_$revision"
  pkg_install() {
    vmove usr/include
    vmove "usr/lib/*.so"
    vmove usr/lib/pkgconfig
    vmove usr/share/bcc/examples
  }
}

python3-bcc_package() {
  lib32disabled="yes"
  short_desc+=" - Python 3 module"
  depends+=" $sourcepkg>=${version}_$revision"
  depends+=" python3"
  pkg_install() {
    vmove "usr/lib/python*"
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

maintainer="nox"
_triplet="arm-none-eabi"
_pkgname="newlib"
pkgname="cross-$_triplet-$_pkgname"
version=3.1.0.20181231
revision=2
short_desc="C library intended for use on embedded systems"
hostmakedepends+=" cross-arm-none-eabi-binutils"
hostmakedepends+=" cross-arm-none-eabi-gcc"
homepage="https://www.sourceware.org/$_pkgname/"
license="GPL-3.0-or-later"
distfiles="ftp://sources.redhat.com/pub/$_pkgname/$_pkgname-$version.tar.gz"
checksum="9e12fea7297648b114434033ed4458755afe7b9b6c7d58123389e82bd37681c0"
wrksrc="$_pkgname-$version"
build_style="gnu-configure"
configure_args+=" --disable-newlib-supplied-syscalls"
configure_args+=" --disable-nls"
configure_args+=" --enable-interwork"
configure_args+=" --enable-newlib-retargetable-locking"
configure_args+=" --host=$XBPS_CROSS_TRIPLET"
configure_args+=" --prefix=/usr"
configure_args+=" --target=$_triplet"
configure_args+=" --with-gnu-as"
configure_args+=" --with-gnu-ld"
nostrip="yes"

post_extract() {
  mkdir -p build-{newlib,nano}
}

do_configure() {
  pushd build-newlib
  export CFLAGS_FOR_TARGET="-g -O2 -ffunction-sections -fdata-sections"
  ../configure \
    $configure_args \
    --enable-newlib-io-long-long \
    --enable-newlib-register-fini
  popd

  pushd build-nano
  export CFLAGS_FOR_TARGET="-g -Os -ffunction-sections -fdata-sections"
  ../configure \
    $configure_args \
    --disable-newlib-fseek-optimization \
    --disable-newlib-fvwrite-in-streamio \
    --disable-newlib-unbuf-stream-opt \
    --disable-newlib-wide-orient \
    --enable-lite-exit \
    --enable-newlib-global-atexit \
    --enable-newlib-nano-formatted-io \
    --enable-newlib-nano-malloc \
    --enable-newlib-reent-small
  popd
}

do_build() {
  pushd build-newlib
  make "$makejobs"
  popd

  pushd build-nano
  make "$makejobs"
  popd
}

do_install() {
  pushd build-nano
  make DESTDIR="$DESTDIR" install
  find "$DESTDIR" -regex ".*/lib\(c\|g\|rdimon\)\.a" \
    -exec rename .a _nano.a '{}' \;
  install -d "$DESTDIR/usr/$_triplet/include/newlib-nano"
  install -m 644 -t "$DESTDIR/usr/$_triplet/include/newlib-nano" \
    "$DESTDIR/usr/$_triplet/include/newlib.h"
  popd

  pushd build-newlib
  make DESTDIR="$DESTDIR" install
  popd
}

post_install() {
  vlicense COPYING
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:

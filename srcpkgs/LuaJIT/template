maintainer="Andy Weidenbaum <archbaum@gmail.com>"
pkgname="LuaJIT"
version=2.1.0beta3
revision=1
_so_version=2.1.0
_dist_version="$_so_version-beta3"
short_desc="Just-In-Time Compiler for Lua"
hostmakedepends="lua52-BitOp"
if [[ -n "$CROSS_BUILD" ]] && [[ "$XBPS_MACHINE" == "x86_64" ]]; then
  hostmakedepends+=" gcc-multilib"
fi
homepage="http://www.luajit.org"
license="MIT"
distfiles="http://luajit.org/download/$pkgname-$_dist_version.tar.gz"
checksum="1ad2e34b111c802f9d0cdf019e986909123237a28c746b21295b63c9e785d9c3"
wrksrc="$pkgname-$_dist_version"

_cross_cc="cc"
if [[ -n "$CROSS_BUILD" ]]; then
  # cross toolchains are only for x86_64, ppc64 and i686 hosts
  # luajit needs matching bitness for host and target
  # on x86_64 we can multilib, on others we can't
  case "$XBPS_MACHINE" in
    x86_64)
      case "$XBPS_TARGET_MACHINE" in
        ppc64*)
          ;;
        arm*|i686*|mips*|ppc*)
          _cross_cc="cc -m32"
          ;;
      esac
      ;;
    ppc64*|x86_64-musl)
      case "$XBPS_TARGET_MACHINE" in
        ppc64*)
          ;;
        arm*|i686*|mips*|ppc*)
          broken="Mismatched bitness on non-multilib host"
          ;;
      esac
      ;;
    i686*)
      case "$XBPS_TARGET_MACHINE" in
        x86_64*|ppc64*|aarch64*)
          broken="Mismatched bitness on non-multilib host"
          ;;
      esac
      ;;
  esac
fi

do_build() {
  local _cflags
  local _ldflags

  _cflags="$CFLAGS"
  _ldflags="$LDFLAGS"

  if [[ -n "$CROSS_BUILD" ]]; then
    local cross="CROSS=$XBPS_CROSS_TRIPLET-"
  fi

  unset CFLAGS
  unset LDFLAGS
  make \
    "$makejobs" \
    HOST_CC="$_cross_cc" \
    HOST_CFLAGS="$XBPS_CFLAGS" \
    HOST_LDFLAGS="$XBPS_LDFLAGS" \
    HOST_LUA="lua5.2" \
    PREFIX="/usr" \
    TARGET_CFLAGS="$_cflags" \
    TARGET_LDFLAGS="$_ldflags" \
    $cross
}

do_install() {
  make \
    DESTDIR="$DESTDIR" \
    DPREFIX="$DESTDIR/usr" \
    INSTALL_SHARE="$DESTDIR/usr/share" \
    PREFIX="/usr" \
    install

  mv "$DESTDIR/usr/bin"/luajit-* "$DESTDIR/usr/bin/luajit"
  ln -fs "libluajit-5.1.so.$_so_version" "$DESTDIR/usr/lib/libluajit-5.1.so.2"
  vlicense COPYRIGHT
}

LuaJIT-devel_package() {
  depends="$sourcepkg>=${version}_$revision"
  short_desc+=" - development files"
  pkg_install() {
    vmove usr/include
    vmove usr/lib/pkgconfig
    vmove "usr/lib/*.a"
    vmove "usr/lib/*.so"
  }
}

# vim: set filetype=sh foldmethod=marker foldlevel=0 nowrap:
